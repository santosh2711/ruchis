<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta name="theme-color" content="#f97316" />
	<title>RUCHI Cashier Dashboard</title>
	<style>
		:root {
			--orange: #f97316;
			--orange-dark: #ea580c;
			--blue: #2563eb;
			--green: #16a34a;
			--red: #dc2626;
			--black: #0f172a;
			--border: #e2e8f0;
			--gray: #f8fafc;
			--card: #ffffff;
		}

		* { box-sizing: border-box; }

		body {
			margin: 0;
			font-family: "Segoe UI", Tahoma, sans-serif;
			background: #f5f7fb;
			color: var(--black);
			padding: 18px 14px 28px;
		}

		header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			gap: 12px;
			max-width: 1200px;
			margin: 0 auto 16px;
		}

		h1 {
			margin: 0;
			font-size: 26px;
			letter-spacing: 0.4px;
			color: var(--orange);
		}

		.subtle { color: #475569; font-weight: 600; font-size: 14px; margin: 0; }
		.header-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
		.logout-btn {
			border: 1px solid var(--border);
			background: #fff;
			color: var(--black);
			padding: 8px 12px;
			border-radius: 10px;
			font-weight: 700;
			cursor: pointer;
		}

		main { max-width: 1200px; margin: 0 auto; display: grid; gap: 16px; }

		.category-nav {
			display: flex;
			gap: 8px;
			flex-wrap: wrap;
			margin: 4px 0 12px;
		}

		.category-pill {
			border: 1px solid var(--border);
			background: #fff;
			color: var(--black);
			padding: 8px 12px;
			border-radius: 999px;
			font-weight: 800;
			cursor: pointer;
			transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease;
		}

		.category-pill.active {
			background: #fff7ed;
			border-color: var(--orange);
			color: var(--orange-dark);
		}

		.section {
			background: var(--card);
			border: 1px solid var(--border);
			border-radius: 16px;
			box-shadow: 0 12px 30px rgba(0,0,0,0.06);
			padding: 14px;
		}

		.section h2 {
			margin: 0 0 10px;
			font-size: 18px;
			color: var(--orange-dark);
		}

		/* POS (cashier) */
		.pos-card { display: grid; gap: 12px; }
		.pos-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
		.pos-input, .pos-select, .pos-textarea, .pos-search {
			width: 100%;
			padding: 10px 12px;
			border: 1px solid var(--border);
			border-radius: 10px;
			font-weight: 700;
		}
		.pos-textarea { min-height: 60px; resize: vertical; }
		.pos-main-nav, .pos-categories, .pos-quick { display: flex; gap: 8px; flex-wrap: wrap; }
		.pos-main-pill, .pos-cat-pill, .pos-quick-btn {
			border: 1px solid var(--border);
			background: #fff;
			color: var(--black);
			padding: 9px 12px;
			border-radius: 999px;
			font-weight: 800;
			cursor: pointer;
			transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease;
		}
		.pos-main-pill.active, .pos-cat-pill.active, .pos-quick-btn.active { background: #fff7ed; border-color: var(--orange); color: var(--orange-dark); }
		.pos-items { display: grid; gap: 10px; }
		.pos-menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
		.pos-card-item {
			border: 1px solid var(--border);
			border-radius: 14px;
			padding: 12px;
			background: #ffffff;
			box-shadow: 0 8px 18px rgba(0,0,0,0.06);
			display: grid;
			grid-template-columns: 80px 1fr;
			grid-template-rows: auto auto;
			gap: 8px 10px;
			align-items: center;
		}
		.pos-thumb { width: 80px; height: 80px; border-radius: 10px; object-fit: cover; background: var(--gray); }
		.pos-item-info { display: flex; flex-direction: column; gap: 4px; }
		.pos-item-title { margin: 0; font-size: 16px; font-weight: 800; color: var(--black); }
		.pos-item-price { font-weight: 800; color: var(--orange-dark); }
		.pos-qty-wrap { display: inline-flex; align-items: center; gap: 10px; padding: 6px 10px; border: 1px solid var(--border); border-radius: 999px; background: var(--gray); }
		.pos-qty-btn { width: 30px; height: 30px; border-radius: 50%; border: none; background: var(--orange); color: #fff; font-weight: 800; cursor: pointer; }
		.pos-add-btn { border: 1px dashed var(--border); background: #fff7ed; color: var(--orange-dark); padding: 10px 12px; border-radius: 10px; font-weight: 800; cursor: pointer; }
		.pos-cart {
			border: 1px solid var(--border);
			border-radius: 14px;
			padding: 12px;
			background: #ffffff;
			box-shadow: 0 8px 18px rgba(0,0,0,0.08);
			display: grid;
			gap: 10px;
		}
		.pos-cart-list { display: grid; gap: 8px; max-height: 240px; overflow-y: auto; }
		.pos-cart-row { display: grid; grid-template-columns: 1fr auto; gap: 6px; padding: 10px 12px; border: 1px solid var(--border); border-radius: 12px; }
		.pos-cart-row h5 { margin: 0; font-size: 14px; }
		.pos-cart-meta { color: #475569; font-size: 12px; font-weight: 700; }
		.pos-cart-qty { display: inline-flex; align-items: center; gap: 6px; }
		.pos-cart-btn { width: 28px; height: 28px; border-radius: 50%; border: none; background: var(--orange); color: #fff; font-weight: 800; cursor: pointer; }
		.pos-cart-summary { display: flex; justify-content: space-between; font-weight: 900; }
		.pos-send { width: 100%; padding: 12px 14px; border: none; border-radius: 12px; background: var(--blue); color: #fff; font-weight: 900; cursor: pointer; }
		.pos-send:disabled { opacity: 0.6; cursor: not-allowed; }
		.pos-status { font-weight: 800; color: var(--red); }

		.manual-card { display: grid; gap: 12px; margin-bottom: 4px; }
		.manual-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; }
		.manual-input, .manual-select, .manual-textarea {
			width: 100%;
			padding: 10px 12px;
			border: 1px solid var(--border);
			border-radius: 10px;
			font-weight: 700;
		}
		.manual-textarea { min-height: 68px; resize: vertical; }
		.manual-row { display: grid; grid-template-columns: 2fr 80px 110px 1.4fr auto; gap: 8px; align-items: center; }
		.manual-row input { width: 100%; }
		.manual-row .remove-btn {
			border: 1px solid var(--border);
			background: #fff1f2;
			color: #b91c1c;
			border-radius: 10px;
			padding: 8px 10px;
			font-weight: 800;
			cursor: pointer;
		}
		.manual-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
		.manual-add { border: 1px dashed var(--border); background: #fff7ed; color: var(--orange-dark); border-radius: 10px; padding: 10px 12px; font-weight: 800; cursor: pointer; }
		.manual-submit { background: var(--blue); color: #fff; border: none; border-radius: 10px; padding: 11px 14px; font-weight: 900; cursor: pointer; }
		.manual-status { font-weight: 800; color: var(--red); }
		.manual-total { font-weight: 900; color: var(--black); margin-left: auto; }

		.orders { display: grid; gap: 12px; }

		.card {
			background: #fff;
			border: 1px solid var(--border);
			border-radius: 14px;
			padding: 12px;
			box-shadow: 0 8px 24px rgba(0,0,0,0.05);
			display: flex;
			flex-direction: column;
			gap: 10px;
		}

		.card-header {
			display: flex;
			justify-content: space-between;
			align-items: flex-start;
			gap: 10px;
			flex-wrap: wrap;
		}

		.title { font-weight: 800; font-size: 16px; }

		.pills { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }

		.pill {
			border-radius: 999px;
			padding: 6px 10px;
			font-weight: 800;
			font-size: 12px;
			display: inline-flex;
			align-items: center;
			gap: 6px;
			color: #fff;
			letter-spacing: 0.2px;
		}

		.pill.table { background: #0f172a; }
		.pill.dine { background: var(--blue); }
		.pill.take { background: var(--orange); }
		.pill.cashier { background: #0ea5e9; }
		.pill.paid { background: var(--green); }
		.pill.unpaid { background: #1e293b; }
		.pill.cancelled { background: var(--red); }
		.pill.ready { background: var(--green); }
		.pill.kitchen { background: #0f172a; }
		.pill.buffet { background: #475569; }

		.items { margin: 0; padding-left: 18px; font-weight: 700; }
		.items li { margin: 3px 0; }
		.item-meta { color: #475569; font-weight: 600; font-size: 13px; }

		.row { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; }
		.meta { color: #475569; font-size: 13px; font-weight: 700; }
		.notes {
			margin: 0;
			padding: 8px 10px;
			border-radius: 10px;
			background: #fff7ed;
			color: #9a3412;
			font-weight: 700;
		}

		.actions { display: flex; gap: 8px; flex-wrap: wrap; }
		.btn {
			border: none;
			border-radius: 10px;
			padding: 10px 12px;
			font-weight: 800;
			cursor: pointer;
			transition: transform 0.15s ease, box-shadow 0.15s ease;
		}
		.btn:active { transform: scale(0.985); }
		.btn.pay { background: var(--green); color: #fff; }
		.btn.cancel { background: var(--red); color: #fff; }
		.btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

		.badge { border-radius: 999px; padding: 4px 8px; font-weight: 800; font-size: 12px; }
		.total { font-weight: 800; font-size: 15px; }

		/* Modal */
		.modal-overlay {
			position: fixed;
			inset: 0;
			background: rgba(0,0,0,0.35);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 200;
		}
		.modal-overlay.active { display: flex; }

		.modal {
			background: #fff;
			border-radius: 12px;
			padding: 18px 16px;
			width: min(360px, 90vw);
			border: 1px solid var(--border);
			box-shadow: 0 18px 40px rgba(0,0,0,0.12);
		}
		.modal h3 { margin: 0 0 8px; color: var(--black); }
		.modal p { margin: 0 0 14px; color: #475569; font-weight: 600; }
		.modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
		.modal .btn { flex: 1; }

		/* Auth overlay */
		.auth-overlay {
			position: fixed;
			inset: 0;
			background: rgba(0,0,0,0.45);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 300;
		}

		.auth-overlay.active { display: flex; }

		.auth-card {
			background: #fff;
			border-radius: 14px;
			padding: 18px 16px 16px;
			width: min(380px, 92vw);
			border: 1px solid var(--border);
			box-shadow: 0 18px 40px rgba(0,0,0,0.14);
		}

		.auth-card h3 { margin: 0 0 8px; color: var(--orange-dark); }
		.auth-card p { margin: 0 0 12px; color: #475569; font-weight: 600; }
		.auth-card .input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 10px; font-size: 14px; }
		.auth-actions { display: flex; gap: 10px; margin-top: 4px; }
		.auth-btn { flex: 1; border: none; border-radius: 10px; padding: 11px 12px; font-weight: 800; cursor: pointer; }
		.auth-btn.primary { background: var(--orange); color: #fff; }
		.auth-btn.secondary { background: #fff; color: var(--black); border: 1px solid var(--border); }
		.auth-error { color: var(--red); font-weight: 700; margin-top: 6px; }

		@media (max-width: 900px) {
			header { flex-direction: column; align-items: flex-start; }
			h1 { font-size: 24px; }
		}
	</style>
</head>
<body>
	<header>
		<div>
			<h1>RUCHI Cashier Dashboard</h1>
			<p class="subtle">Live orders from Firestore</p>
		</div>
		<div class="header-actions">
			<div class="subtle" id="last-updated">Updated: —</div>
			<a class="logout-btn" href="manage-menu.html" style="text-decoration:none;">Manage menu</a>
			<button class="logout-btn" id="pos-toggle" type="button">Hide POS</button>
			<button class="logout-btn" id="logout-btn" type="button" style="display:none;">Log out</button>
		</div>
	</header>

	<main>
		<section class="section pos-card" id="pos-card">
			<div class="row" style="align-items:center;">
				<h2 style="margin:0;">POS order</h2>
				<button class="logout-btn" id="pos-toggle-inline" type="button">Hide POS</button>
			</div>
			<div id="pos-body">
				<div class="pos-row">
					<div>
						<label class="subtle" for="pos-table">Table (optional)</label>
						<input id="pos-table" class="pos-input" type="text" placeholder="Table number" />
					</div>
					<div>
						<label class="subtle" for="pos-service">Service</label>
						<select id="pos-service" class="pos-select">
							<option value="dine-in">Dine-in</option>
							<option value="takeaway">Takeaway</option>
						</select>
					</div>
					<div>
						<label class="subtle" for="pos-send-kitchen">Send to kitchen</label>
						<div style="display:flex;align-items:center;gap:8px;">
							<input id="pos-send-kitchen" type="checkbox" checked />
							<span class="meta">Forward to kitchen display</span>
						</div>
					</div>
				</div>
				<div class="pos-row">
					<div style="grid-column: 1 / -1;">
						<label class="subtle" for="pos-note">Order note</label>
						<textarea id="pos-note" class="pos-textarea" placeholder="Notes for kitchen or cashier"></textarea>
					</div>
				</div>
				<div class="pos-row" style="align-items:center;">
					<input id="pos-search" class="pos-search" type="search" placeholder="Search items" />
					<button id="pos-search-btn" class="logout-btn" type="button">Search</button>
				</div>
				<div class="pos-main-nav" id="pos-main-nav"></div>
				<div class="pos-categories" id="pos-categories"></div>
				<div class="pos-items" id="pos-items"></div>
				<div class="pos-cart" id="pos-cart" style="display:none;">
					<div class="pos-cart-list" id="pos-cart-list"></div>
					<div class="pos-cart-summary">
						<span>Total</span>
						<span id="pos-total">RM 0.00</span>
					</div>
					<div style="display:flex; gap:8px; flex-wrap:wrap;">
						<button id="pos-clear" class="logout-btn" type="button">Clear cart</button>
						<button id="pos-submit" class="pos-send" type="button">Add order</button>
					</div>
					<div id="pos-status" class="pos-status"></div>
				</div>
			</div>
		</section>

		<section class="section manual-card" id="manual-card">
			<div class="row" style="align-items:center;">
				<h2 style="margin:0;">Manual items</h2>
				<span class="subtle">Use for items not in database</span>
				<button class="logout-btn" id="manual-toggle-inline" type="button">Hide manual</button>
			</div>
			<div id="manual-body">
				<div class="manual-grid">
					<div>
						<label class="subtle" for="manual-table">Table (optional)</label>
						<input id="manual-table" class="manual-input" type="text" placeholder="Table number" />
					</div>
					<div>
						<label class="subtle" for="manual-service">Service</label>
						<select id="manual-service" class="manual-select">
							<option value="dine-in">Dine-in</option>
							<option value="takeaway">Takeaway</option>
						</select>
					</div>
					<div>
						<label class="subtle" for="manual-send-kitchen">Send to kitchen</label>
						<div style="display:flex;align-items:center;gap:8px;">
							<input id="manual-send-kitchen" type="checkbox" checked />
							<span class="meta">Forward to kitchen display</span>
						</div>
					</div>
					<div>
						<label class="subtle" for="manual-note">Order note</label>
						<textarea id="manual-note" class="manual-textarea" placeholder="Notes for kitchen or cashier"></textarea>
					</div>
				</div>
				<div class="manual-items" id="manual-items"></div>
				<div class="manual-actions">
					<button id="manual-add-item" class="manual-add" type="button">Add item</button>
					<div id="manual-total" class="manual-total">Total: RM 0.00</div>
					<button id="manual-submit" class="manual-submit" type="button">Add order</button>
				</div>
				<div id="manual-status" class="manual-status"></div>
			</div>
		</section>

		<section class="section">
			<h2>Orders</h2>
			<div class="category-nav" id="category-nav"></div>
			<div id="orders-list" class="orders"></div>
		</section>
	</main>

	<!-- Auth overlay -->
	<div class="auth-overlay" id="auth-overlay">
		<div class="auth-card">
			<h3>Cashier Login</h3>
			<p>Sign in to manage orders.</p>
			<input id="auth-email" class="input" type="email" placeholder="Email" />
			<input id="auth-password" class="input" type="password" placeholder="Password" />
			<div class="auth-actions">
				<button class="auth-btn primary" id="auth-signin" type="button">Sign in</button>
			</div>
			<div class="auth-error" id="auth-error"></div>
		</div>
	</div>

	<script type="module">
		import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
		import { getFirestore, collection, query, orderBy, onSnapshot, updateDoc, doc, addDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
		import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

		// Firebase config (provided)
		const firebaseConfig = {
			apiKey: "AIzaSyCS1WJJQ7QQnqRhtwuTQCPpjjb3tIjQ3nQ",
			authDomain: "ruchi-53a14.firebaseapp.com",
			projectId: "ruchi-53a14",
			storageBucket: "ruchi-53a14.firebasestorage.app",
			messagingSenderId: "473906899822",
			appId: "1:473906899822:web:07640feeca4e379aaa6f7f",
			measurementId: "G-J1CQDC048C"
		};

		// Init Firebase
		const app = initializeApp(firebaseConfig);
		const db = getFirestore(app);
		const auth = getAuth(app);

		// DOM references
		const ordersList = document.getElementById("orders-list");
		const lastUpdated = document.getElementById("last-updated");
		const categoryNav = document.getElementById("category-nav");
		const authOverlay = document.getElementById("auth-overlay");
		const authEmail = document.getElementById("auth-email");
		const authPassword = document.getElementById("auth-password");
		const authSignin = document.getElementById("auth-signin");
		const authError = document.getElementById("auth-error");
		const logoutBtn = document.getElementById("logout-btn");
		const posToggle = document.getElementById("pos-toggle");
		const posToggleInline = document.getElementById("pos-toggle-inline");
		const posBody = document.getElementById("pos-body");
		const manualToggleInline = document.getElementById("manual-toggle-inline");
		const manualBody = document.getElementById("manual-body");
		const posMainNav = document.getElementById("pos-main-nav");
		const posCategories = document.getElementById("pos-categories");
		const posItemsPanel = document.getElementById("pos-items");
		const posCartList = document.getElementById("pos-cart-list");
		const posCartEl = document.getElementById("pos-cart");
		const posTotal = document.getElementById("pos-total");
		const posSubmit = document.getElementById("pos-submit");
		const posClear = document.getElementById("pos-clear");
		const posStatus = document.getElementById("pos-status");
		const posSearch = document.getElementById("pos-search");
		const posSearchBtn = document.getElementById("pos-search-btn");
		const posTableInput = document.getElementById("pos-table");
		const posService = document.getElementById("pos-service");
		const posSendKitchen = document.getElementById("pos-send-kitchen");
		const posNote = document.getElementById("pos-note");
		const manualItemsContainer = document.getElementById("manual-items");
		const manualAddItemBtn = document.getElementById("manual-add-item");
		const manualTableInput = document.getElementById("manual-table");
		const manualNoteInput = document.getElementById("manual-note");
		const manualService = document.getElementById("manual-service");
		const manualSendKitchen = document.getElementById("manual-send-kitchen");
		const manualSubmit = document.getElementById("manual-submit");
		const manualStatus = document.getElementById("manual-status");
		const manualTotal = document.getElementById("manual-total");

		// Restrict access to a single authorized account
		const allowedEmail = "shubhakumarvel@gmail.com"; // TODO: replace with the real cashier email
		authEmail.value = allowedEmail;
		authEmail.readOnly = true;

		// Category mapping (mirrors menu page, no time windows)
		const CATEGORY_MAP = {
			Breakfast: ["Chapati", "Dosa", "Egg Options", "Idly", "Nasi Lemak", "Roti Canai", "Roti Varieties"],
			Lunch: ["Add On", "Banana Leaf", "Banana Leaf Meal", "Briyani", "Biryani", "Chapati", "Chicken Options", "Claypot", "Egg Options", "Mutton Options", "Seafood Options"],
			Dinner: ["Chapati", "Claypot", "Dosa", "Egg Options", "Finger Foods", "Goreng", "Nasi Lemak", "Parotta", "Rolls", "Roti Canai", "Roti Varieties", "Sandwich", "Special Chicken"],
			Drinks: ["Coffee", "Juices", "Lassi", "Milk Drinks", "Tea"],
		};

		const MAIN_CATEGORIES = ["All", "Breakfast", "Lunch", "Dinner", "Drinks"];
		const SUBCATEGORY_ORDER = {
			All: ["Banana Leaf", "Banana Leaf Meal", "Claypot", "Briyani", "Biryani"],
			Lunch: ["Banana Leaf", "Banana Leaf Meal", "Claypot", "Briyani", "Biryani"],
		};

		const subToMain = (() => {
			const map = {};
			Object.entries(CATEGORY_MAP).forEach(([main, subs]) => {
				subs.forEach((sub) => {
					const key = (sub || "").toLowerCase();
					if (!map[key]) map[key] = [];
					map[key].push(main);
				});
			});
			return map;
		})();

		const normalizeSubcategory = (raw) => {
			const cleaned = (raw || "").trim();
			if (!cleaned) return "General";
			const lower = cleaned.toLowerCase();
			if (lower === "others" || lower === "other") return "General";
			return cleaned;
		};

		const getMainCategoriesForItem = (item) => {
			const sub = normalizeSubcategory(item?.category || item?.cat || "");
			const mains = subToMain[sub.toLowerCase()] || [];
			return mains.length ? mains : ["Unmapped"];
		};

		let activeMain = "All";
		let ordersData = [];
		let posMenuItems = [];
		let posCart = [];
		let posActiveMain = "All";
		let posSelectedCategory = "";
		let posSearchTerm = "";
		let posLoadingMenu = false;
		let posMenuError = "";
		let manualItems = [{ name: "", qty: 1, price: "", category: "", prep: "kitchen" }];

		const formatCurrency = (v) => `RM ${Number(v || 0).toFixed(2)}`;
		const formatTimestamp = (ts) => {
			if (!ts) return "";
			const value = typeof ts === "number" ? ts : ts?.toMillis?.();
			if (!value) return "";
			const d = new Date(value);
			return d.toLocaleString(undefined, { month: "short", day: "numeric", hour: "2-digit", minute: "2-digit" });
		};

		const emptyManualItem = () => ({ name: "", qty: 1, price: "", category: "", prep: "kitchen" });

		const updateManualTotal = () => {
			if (!manualTotal) return;
			const total = manualItems.reduce((sum, i) => {
				if (!i.name?.trim()) return sum;
				const qty = Number(i.qty) || 0;
				const price = Number(i.price) || 0;
				return sum + qty * price;
			}, 0);
			manualTotal.textContent = `Total: ${formatCurrency(total)}`;
		};

		const renderManualItems = () => {
			if (!manualItemsContainer) return;
			manualItemsContainer.innerHTML = "";
			const header = document.createElement("div");
			header.className = "manual-row subtle";
			header.innerHTML = "<span>Item</span><span>Qty</span><span>Price</span><span>Category</span><span></span>";
			manualItemsContainer.appendChild(header);
			manualItems.forEach((item, idx) => {
				const row = document.createElement("div");
				row.className = "manual-row";
				const name = document.createElement("input");
				name.className = "manual-input";
				name.placeholder = "Item name";
				name.value = item.name;
				name.addEventListener("input", (e) => { manualItems[idx].name = e.target.value; updateManualTotal(); });

				const qty = document.createElement("input");
				qty.className = "manual-input";
				qty.type = "number";
				qty.min = "1";
				qty.value = item.qty;
				qty.addEventListener("input", (e) => { manualItems[idx].qty = Number(e.target.value) || 1; updateManualTotal(); });

				const price = document.createElement("input");
				price.className = "manual-input";
				price.type = "number";
				price.step = "0.01";
				price.min = "0";
				price.value = item.price;
				price.addEventListener("input", (e) => { manualItems[idx].price = e.target.value; updateManualTotal(); });

				const cat = document.createElement("input");
				cat.className = "manual-input";
				cat.placeholder = "Category (optional)";
				cat.value = item.category || "";
				cat.addEventListener("input", (e) => { manualItems[idx].category = e.target.value; });

				row.appendChild(name);
				row.appendChild(qty);
				row.appendChild(price);
				row.appendChild(cat);

				const actions = document.createElement("div");
				if (manualItems.length > 1) {
					const remove = document.createElement("button");
					remove.type = "button";
					remove.className = "remove-btn";
					remove.textContent = "Remove";
					remove.addEventListener("click", () => {
						manualItems.splice(idx, 1);
						renderManualItems();
					});
					actions.appendChild(remove);
				}
				row.appendChild(actions);
				manualItemsContainer.appendChild(row);
			});
			updateManualTotal();
		};

		const resetManualForm = () => {
			manualItems = [emptyManualItem()];
			if (manualTableInput) manualTableInput.value = "";
			if (manualNoteInput) manualNoteInput.value = "";
			if (manualService) manualService.value = "dine-in";
			if (manualSendKitchen) manualSendKitchen.checked = true;
			renderManualItems();
			if (manualStatus) manualStatus.textContent = "";
		};

		const posItemMatchesMain = (item, main) => {
			if (main === "All") return true;
			const sub = normalizeSubcategory(item?.category || "");
			const mains = subToMain[sub.toLowerCase()] || [];
			return mains.includes(main);
		};

		const posUniqueCategories = () => {
			const set = new Set();
			posMenuItems.forEach((i) => {
				if (!posItemMatchesMain(i, posActiveMain)) return;
				if (i.category) set.add(normalizeSubcategory(i.category));
			});
			const cats = Array.from(set);
			const order = SUBCATEGORY_ORDER[posActiveMain] || [];
			const rank = (label) => {
				const idx = order.findIndex((v) => v.toLowerCase() === (label || "").toLowerCase());
				return idx === -1 ? Number.POSITIVE_INFINITY : idx;
			};
			return cats.sort((a, b) => {
				const ra = rank(a);
				const rb = rank(b);
				if (ra !== rb) return ra - rb;
				return a.localeCompare(b, "en", { sensitivity: "base" });
			});
		};

		const renderPosCategories = () => {
			if (!posCategories) return;
			posCategories.innerHTML = "";
			if (posLoadingMenu) {
				const card = document.createElement("div");
				card.className = "subtle";
				card.textContent = "Loading menu…";
				posCategories.appendChild(card);
				return;
			}
			if (posMenuError) {
				const card = document.createElement("div");
				card.className = "subtle";
				card.textContent = posMenuError;
				posCategories.appendChild(card);
				return;
			}
			const cats = posUniqueCategories();
			if (!cats.length) {
				const empty = document.createElement("div");
				empty.className = "subtle";
				empty.textContent = "No categories";
				posCategories.appendChild(empty);
				return;
			}
			cats.forEach((cat, idx) => {
				const btn = document.createElement("button");
				btn.className = "pos-cat-pill";
				btn.textContent = cat || "Category";
				btn.classList.toggle("active", cat === posSelectedCategory);
				btn.addEventListener("click", () => {
					posSelectedCategory = cat;
					renderPosCategories();
					renderPosItems();
				});
				posCategories.appendChild(btn);
				if (!posSelectedCategory && idx === 0) posSelectedCategory = cat;
			});
			if (posSelectedCategory && !cats.includes(posSelectedCategory)) {
				posSelectedCategory = cats[0];
				renderPosCategories();
			}
		};

		const posUpdateCart = (item, delta) => {
			const existing = posCart.find((c) => c.id === item.id);
			if (existing) {
				existing.qty += delta;
				if (existing.qty <= 0) posCart = posCart.filter((c) => c.id !== item.id);
			} else if (delta > 0) {
				posCart.push({ id: item.id, name: item.name || "Item", price: Number(item.price) || 0, qty: 1, category: item.category || "", prep: item.prep || "kitchen" });
			}
			renderPosItems();
			renderPosCart();
		};

		const renderPosItems = () => {
			if (!posItemsPanel) return;
			posItemsPanel.innerHTML = "";
			if (posLoadingMenu) {
				const card = document.createElement("div");
				card.className = "subtle";
				card.textContent = "Loading menu…";
				posItemsPanel.appendChild(card);
				return;
			}
			if (posMenuError) {
				const card = document.createElement("div");
				card.className = "subtle";
				card.textContent = posMenuError;
				posItemsPanel.appendChild(card);
				return;
			}
			const list = posMenuItems.filter((i) => {
				const matchesMain = posItemMatchesMain(i, posActiveMain);
				const matchesCategory = normalizeSubcategory(i.category) === posSelectedCategory;
				const matchesSearch = !posSearchTerm || (i.name || "").toLowerCase().includes(posSearchTerm);
				return matchesMain && matchesCategory && matchesSearch;
			});
			if (!list.length) {
				const empty = document.createElement("div");
				empty.className = "subtle";
				empty.textContent = posSearchTerm ? "No items match your search" : "No items in this category";
				posItemsPanel.appendChild(empty);
				return;
			}
			const grid = document.createElement("section");
			grid.className = "pos-menu-grid";
			list.forEach((item) => {
				const card = document.createElement("article");
				card.className = "pos-card-item";
				card.tabIndex = 0;

				const img = document.createElement("img");
				img.className = "pos-thumb";
				img.src = item.image || item.imageURL || "https://via.placeholder.com/120x120?text=No+Image";
				img.alt = item.name || "Item";
				img.loading = "lazy";
				img.decoding = "async";

				const info = document.createElement("div");
				info.className = "pos-item-info";
				const title = document.createElement("h3");
				title.className = "pos-item-title";
				title.textContent = item.name || "Item";
				const price = document.createElement("div");
				price.className = "pos-item-price";
				price.textContent = formatCurrency(item.price);
				info.append(title, price);

				card.addEventListener("click", () => posUpdateCart(item, 1));
				card.addEventListener("keypress", (e) => { if (e.key === "Enter" || e.key === " ") posUpdateCart(item, 1); });

				const controls = document.createElement("div");
				const existing = posCart.find((c) => c.id === item.id);
				if (existing) {
					const wrap = document.createElement("div");
					wrap.className = "pos-qty-wrap";
					const dec = document.createElement("button");
					dec.className = "pos-qty-btn";
					dec.textContent = "-";
					dec.addEventListener("click", (e) => { e.stopPropagation(); posUpdateCart(item, -1); });
					const val = document.createElement("div");
					val.textContent = existing.qty;
					const inc = document.createElement("button");
					inc.className = "pos-qty-btn";
					inc.textContent = "+";
					inc.addEventListener("click", (e) => { e.stopPropagation(); posUpdateCart(item, 1); });
					wrap.append(dec, val, inc);
					controls.appendChild(wrap);
				} else {
					const add = document.createElement("button");
					add.className = "pos-add-btn";
					add.textContent = "Add";
					add.addEventListener("click", (e) => { e.stopPropagation(); posUpdateCart(item, 1); });
					controls.appendChild(add);
				}

				card.append(img, info, controls);
				grid.appendChild(card);
			});
			posItemsPanel.appendChild(grid);
		};

		const renderPosCart = () => {
			if (!posCartList || !posTotal || !posCartEl) return;
			posCartList.innerHTML = "";
			const hasItems = posCart.length > 0;
			posCartEl.style.display = hasItems ? "grid" : "none";
			if (posSubmit) posSubmit.disabled = !hasItems;
			if (posClear) posClear.disabled = !hasItems;
			const total = posCart.reduce((sum, i) => sum + (i.price || 0) * (i.qty || 0), 0);
			posTotal.textContent = formatCurrency(total);
			if (!hasItems) {
				const empty = document.createElement("div");
				empty.className = "subtle";
				empty.textContent = "Cart is empty";
				posCartList.appendChild(empty);
				return;
			}
			const frag = document.createDocumentFragment();
			posCart.forEach((item) => {
				const row = document.createElement("div");
				row.className = "pos-cart-row";
				const left = document.createElement("div");
				const title = document.createElement("h5");
				title.textContent = item.name;
				const meta = document.createElement("div");
				meta.className = "pos-cart-meta";
				meta.textContent = item.category || "";
				left.append(title, meta);

				const qty = document.createElement("div");
				qty.className = "pos-cart-qty";
				const dec = document.createElement("button");
				dec.className = "pos-cart-btn";
				dec.textContent = "-";
				dec.addEventListener("click", () => posUpdateCart(item, -1));
				const val = document.createElement("div");
				val.textContent = item.qty;
				const inc = document.createElement("button");
				inc.className = "pos-cart-btn";
				inc.textContent = "+";
				inc.addEventListener("click", () => posUpdateCart(item, 1));
				qty.append(dec, val, inc);

				row.append(left, qty);
				frag.appendChild(row);
			});
			posCartList.appendChild(frag);
		};

		const buildPosMainNav = () => {
			if (!posMainNav) return;
			posMainNav.innerHTML = "";
			MAIN_CATEGORIES.forEach((main) => {
				const btn = document.createElement("button");
				btn.className = "pos-main-pill";
				btn.textContent = main;
				btn.classList.toggle("active", main === posActiveMain);
				btn.addEventListener("click", () => {
					posActiveMain = main;
					posSelectedCategory = "";
					buildPosMainNav();
					renderPosCategories();
					renderPosItems();
				});
				posMainNav.appendChild(btn);
			});
		};

		const fetchPosMenu = async () => {
			if (posLoadingMenu) return;
			posLoadingMenu = true;
			posMenuError = "";
			renderPosCategories();
			renderPosItems();
			try {
				const snap = await getDocs(collection(db, "menuItems"));
				posMenuItems = snap.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
				if (!posSelectedCategory && posMenuItems.length) {
					const firstCat = normalizeSubcategory(posMenuItems[0].category);
					posSelectedCategory = firstCat;
				}
				if (!posMenuItems.length) posMenuError = "Menu is empty. Add items in Firestore.";
			} catch (err) {
				console.error("POS menu load failed", err);
				posMenuError = "Could not load menu.";
			} finally {
				posLoadingMenu = false;
				buildPosMainNav();
				renderPosCategories();
				renderPosItems();
			}
		};

		const clearPosCart = () => {
			posCart = [];
			renderPosItems();
			renderPosCart();
			if (posStatus) posStatus.textContent = "";
		};

		const sendPosOrder = async () => {
			if (!posSubmit) return;
			if (posStatus) {
				posStatus.textContent = "";
				posStatus.style.color = "var(--red)";
			}
			if (!posCart.length) {
				if (posStatus) posStatus.textContent = "Add items to send.";
				return;
			}
			posSubmit.disabled = true;
			posSubmit.textContent = "Adding...";
			try {
				const table = (posTableInput?.value || "").trim();
				const sentToKitchen = posSendKitchen ? !!posSendKitchen.checked : true;
				const items = posCart.map((i, idx) => ({
					id: i.id || `pos-${idx}`,
					name: i.name,
					qty: i.qty,
					price: i.price,
					prep: i.prep || "kitchen",
					category: i.category || "",
					note: "",
				}));
				const payload = {
					tableNumber: table,
					table: table,
					handledBy: "cashier",
					service: posService?.value || "dine-in",
					items,
					notes: (posNote?.value || "").trim(),
					totalPrice: items.reduce((sum, i) => sum + (i.price || 0) * (i.qty || 0), 0),
					paymentStatus: "unpaid",
					sentToKitchen,
					sendToCashier: true,
					orderStatus: sentToKitchen ? "in-kitchen" : "pending",
					timestamp: serverTimestamp(),
					createdAt: serverTimestamp(),
				};
				const docRef = await addDoc(collection(db, "orders"), { ...payload, orderId: "" });
				await updateDoc(docRef, { orderId: docRef.id });
				if (posStatus) {
					posStatus.style.color = "var(--green)";
					posStatus.textContent = "Order added to cashier dashboard.";
				}
				clearPosCart();
			} catch (err) {
				console.error("POS order failed", err);
				if (posStatus) posStatus.textContent = "Could not add order.";
			} finally {
				posSubmit.disabled = false;
				posSubmit.textContent = "Add order";
			}
		};

		const submitManualOrder = async () => {
			if (!manualSubmit) return;
			if (manualStatus) {
				manualStatus.textContent = "";
				manualStatus.style.color = "var(--red)";
			}
			const items = manualItems
				.map((i, idx) => ({
					id: i.id || `manual-${idx}`,
					name: (i.name || "").trim(),
					qty: Number(i.qty) || 1,
					price: Number(i.price) || 0,
					category: (i.category || "").trim(),
					prep: i.prep || "kitchen",
					note: "",
				}))
				.filter((i) => i.name);
			if (!items.length) {
				if (manualStatus) manualStatus.textContent = "Add at least one item.";
				return;
			}
			manualSubmit.disabled = true;
			manualSubmit.textContent = "Adding...";
			try {
				const table = (manualTableInput?.value || "").trim();
				const sentToKitchen = manualSendKitchen ? !!manualSendKitchen.checked : true;
				const payload = {
					tableNumber: table || "",
					table: table || "",
					handledBy: "cashier",
					service: manualService?.value || "dine-in",
					items,
					notes: (manualNoteInput?.value || "").trim(),
					totalPrice: items.reduce((sum, i) => sum + (i.price || 0) * (i.qty || 0), 0),
					paymentStatus: "unpaid",
					sentToKitchen,
					sendToCashier: true,
					orderStatus: sentToKitchen ? "in-kitchen" : "pending",
					timestamp: serverTimestamp(),
					createdAt: serverTimestamp(),
				};
				const docRef = await addDoc(collection(db, "orders"), { ...payload, orderId: "" });
				await updateDoc(docRef, { orderId: docRef.id });
				if (manualStatus) {
					manualStatus.style.color = "var(--green)";
					manualStatus.textContent = "Manual order added.";
				}
				resetManualForm();
			} catch (err) {
				console.error("Manual order failed", err);
				if (manualStatus) manualStatus.textContent = "Could not add order.";
			} finally {
				manualSubmit.disabled = false;
				manualSubmit.textContent = "Add order";
			}
		};

		// Render a single order card
		const renderOrder = (order) => {
			const card = document.createElement("div");
			card.className = "card";

			const header = document.createElement("div");
			header.className = "card-header";

			const title = document.createElement("div");
			title.className = "title";
			title.textContent = `Table ${order.tableNumber || order.table || "-"}`;

			const pills = document.createElement("div");
			pills.className = "pills";

			const handledPill = document.createElement("span");
			const handled = (order.handledBy || "self").toLowerCase();
			let handledClass = "dine";
			let handledLabel = "SELF";
			if (handled === "waiter") {
				handledClass = "take";
				handledLabel = "WAITER";
			} else if (handled === "cashier") {
				handledClass = "cashier";
				handledLabel = "CASHIER";
			}
			handledPill.className = "pill " + handledClass;
			handledPill.textContent = handledLabel;
			pills.appendChild(handledPill);

			const status = (order.paymentStatus || "unpaid").toLowerCase();
			const payPill = document.createElement("span");
			const statusClass = status === "paid" ? "paid" : status === "cancelled" ? "cancelled" : "unpaid";
			payPill.className = "pill " + statusClass;
			payPill.textContent = status.toUpperCase();
			pills.appendChild(payPill);

			header.appendChild(title);
			header.appendChild(pills);
			card.appendChild(header);

			// Items
			const ul = document.createElement("ul");
			ul.className = "items";
			(order.items || []).forEach((it) => {
				const li = document.createElement("li");
				const name = document.createElement("span");
				name.textContent = `${it.qty || 1} x ${it.name || "Item"}`;
				const price = document.createElement("span");
				price.className = "item-meta";
				price.textContent = ` — ${formatCurrency((it.price || 0) * (it.qty || 1))}`;
				const mains = getMainCategoriesForItem(it).filter((m) => m !== "Unmapped");
				if (mains.length) {
					const cats = document.createElement("span");
					cats.className = "item-meta";
					cats.textContent = ` • ${mains.join(" / ")}`;
					price.appendChild(cats);
				}
				li.appendChild(name);
				li.appendChild(price);
				ul.appendChild(li);
			});
			card.appendChild(ul);

			// Notes
			if (order.notes) {
				const notes = document.createElement("p");
				notes.className = "notes";
				notes.textContent = `Notes: ${order.notes}`;
				card.appendChild(notes);
			}

			// Totals & meta
			const metaRow = document.createElement("div");
			metaRow.className = "row";
			const total = document.createElement("div");
			total.className = "total";
			const computedTotal = (order.items || []).reduce((sum, i) => sum + (Number(i.price) || 0) * (i.qty || 1), 0);
			total.textContent = `Total: ${formatCurrency(computedTotal)}`;
			const time = document.createElement("div");
			time.className = "meta";
			time.textContent = formatTimestamp(order.createdAt || order.timestamp);
			metaRow.appendChild(total);
			metaRow.appendChild(time);
			card.appendChild(metaRow);

			// Actions
			const actions = document.createElement("div");
			actions.className = "actions";

			const payBtn = document.createElement("button");
			payBtn.className = "btn pay";
			payBtn.textContent = "Mark as paid";
			payBtn.disabled = status === "paid" || status === "cancelled";
			payBtn.addEventListener("click", () => markPaid(order.id));

			const cancelBtn = document.createElement("button");
			cancelBtn.className = "btn cancel";
			cancelBtn.textContent = "Cancel order";
			cancelBtn.disabled = status === "cancelled";
			cancelBtn.addEventListener("click", () => cancelOrder(order.id));

			actions.appendChild(payBtn);
			actions.appendChild(cancelBtn);
			card.appendChild(actions);

			return card;
		};

		const renderList = (container, orders, emptyText) => {
			container.innerHTML = "";
			if (!orders.length) {
				const empty = document.createElement("div");
				empty.className = "subtle";
				empty.textContent = emptyText;
				container.appendChild(empty);
				return;
			}
			orders.forEach((o) => container.appendChild(renderOrder(o)));
		};

		const orderMatchesActiveMain = (order) => {
			if (activeMain === "All") return true;
			return (order.items || []).some((it) => getMainCategoriesForItem(it).includes(activeMain));
		};

		const renderFilteredOrders = () => {
			const filtered = ordersData.filter(orderMatchesActiveMain);
			renderList(ordersList, filtered, "No orders for this category.");
		};

		// Actions
		const markPaid = async (id) => {
			if (!id) return;
			try {
				await updateDoc(doc(db, "orders", id), { paymentStatus: "paid" });
			} catch (err) {
				console.error("Failed to mark paid", err);
			}
		};

		const cancelOrder = async (id) => {
			if (!id) return;
			try {
				await updateDoc(doc(db, "orders", id), { paymentStatus: "cancelled", orderStatus: "cancelled", sentToKitchen: false });
			} catch (err) {
				console.error("Failed to cancel", err);
			}
		};

		const buildCategoryNav = () => {
			if (!categoryNav) return;
			categoryNav.innerHTML = "";
			MAIN_CATEGORIES.forEach((main) => {
				const btn = document.createElement("button");
				btn.className = "category-pill";
				btn.textContent = main;
				btn.classList.toggle("active", main === activeMain);
				btn.addEventListener("click", () => {
					activeMain = main;
					buildCategoryNav();
					renderFilteredOrders();
				});
				categoryNav.appendChild(btn);
			});
		};

		posSubmit?.addEventListener("click", sendPosOrder);
		posClear?.addEventListener("click", clearPosCart);
		posSearchBtn?.addEventListener("click", () => {
			posSearchTerm = (posSearch?.value || "").trim().toLowerCase();
			renderPosItems();
		});
		posSearch?.addEventListener("keypress", (e) => {
			if (e.key === "Enter") {
				posSearchTerm = (posSearch?.value || "").trim().toLowerCase();
				renderPosItems();
			}
		});

		manualAddItemBtn?.addEventListener("click", () => {
			manualItems.push(emptyManualItem());
			renderManualItems();
		});

		manualSubmit?.addEventListener("click", submitManualOrder);

		posToggle?.addEventListener("click", () => {
			const hidden = posBody.style.display === "none";
			posBody.style.display = hidden ? "grid" : "none";
			posToggle.textContent = hidden ? "Hide POS" : "Show POS";
			if (posToggleInline) posToggleInline.textContent = posToggle.textContent;
		});

		posToggleInline?.addEventListener("click", () => {
			const hidden = posBody.style.display === "none";
			posBody.style.display = hidden ? "grid" : "none";
			posToggleInline.textContent = hidden ? "Hide POS" : "Show POS";
			if (posToggle) posToggle.textContent = posToggleInline.textContent;
		});

		manualToggleInline?.addEventListener("click", () => {
			const hidden = manualBody.style.display === "none";
			manualBody.style.display = hidden ? "grid" : "none";
			manualToggleInline.textContent = hidden ? "Hide manual" : "Show manual";
		});

		buildPosMainNav();
		renderPosCart();
		fetchPosMenu();
		renderManualItems();

		// Live listener (activated only when authenticated)
		let unsubscribe = null;

		const startOrdersListener = () => {
			const ordersRef = collection(db, "orders");
			const q = query(ordersRef, orderBy("createdAt", "desc"));
			unsubscribe = onSnapshot(q, (snapshot) => {
				const all = [];
				snapshot.forEach((docSnap) => {
					const data = docSnap.data();
					all.push({ ...data, id: docSnap.id });
				});
				ordersData = all;
				renderFilteredOrders();
				lastUpdated.textContent = `Updated: ${new Date().toLocaleTimeString()}`;
			}, (error) => {
				console.error("orders onSnapshot error", error);
			});
		};

		const stopOrdersListener = () => {
			if (unsubscribe) {
				unsubscribe();
				unsubscribe = null;
			}
			renderList(ordersList, [], "Sign in to view orders.");
			lastUpdated.textContent = "Updated: —";
		};

		// Auth helpers
		const showAuth = (msg = "") => {
			authError.textContent = msg;
			authEmail.value = allowedEmail;
			authPassword.value = "";
			authOverlay.classList.add("active");
		};

		const hideAuth = () => {
			authOverlay.classList.remove("active");
			authError.textContent = "";
			authEmail.value = allowedEmail;
			authPassword.value = "";
		};

		authSignin.addEventListener("click", async () => {
			const email = (authEmail.value || "").trim();
			const pass = authPassword.value || "";
			if (!email || !pass) {
				authError.textContent = "Enter email and password.";
				return;
			}
			if (email.toLowerCase() !== allowedEmail.toLowerCase()) {
				authError.textContent = "This account is not authorized.";
				return;
			}
			authError.textContent = "";
			authSignin.disabled = true;
			try {
				await signInWithEmailAndPassword(auth, email, pass);
			} catch (err) {
				authError.textContent = err?.message || "Sign-in failed.";
			} finally {
				authSignin.disabled = false;
			}
		});

		logoutBtn.addEventListener("click", async () => {
			logoutBtn.disabled = true;
			try {
				await signOut(auth);
			} catch (err) {
				console.error("Logout failed", err);
			} finally {
				logoutBtn.disabled = false;
			}
		});

		onAuthStateChanged(auth, (user) => {
			if (user) {
				const email = (user.email || "").toLowerCase();
				if (email !== allowedEmail.toLowerCase()) {
					signOut(auth).catch(() => {});
					logoutBtn.style.display = "none";
					stopOrdersListener();
					showAuth("This account is not authorized.");
					return;
				}
				hideAuth();
				logoutBtn.style.display = "inline-flex";
				buildCategoryNav();
				startOrdersListener();
			} else {
				logoutBtn.style.display = "none";
				stopOrdersListener();
				showAuth();
			}
		});

		// TODO: add filters by service/payment in future
	</script>
</body>
</html>
