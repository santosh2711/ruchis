
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta name="theme-color" content="#f97316" />
	<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><rect width='64' height='64' rx='12' fill='%23f97316'/><text x='32' y='40' text-anchor='middle' font-family='Segoe UI' font-size='28' fill='white'>R</text></svg>" />
	<title>Ruchi's Menu</title>
	<style>
		:root {
			--orange: #f97316;
			--orange-dark: #ea580c;
			--black: #0f172a;
			--gray: #f8fafc;
			--border: #e2e8f0;
		}

		* {
			box-sizing: border-box;
		}

		body {
			margin: 0;
			font-family: "Segoe UI", Tahoma, sans-serif;
			background: #ffffff;
			color: var(--black);
			padding-top: 76px;
		}

		body.modal-open {
			overflow: hidden;
		}

		header {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			height: 76px;
			background: #ffffff;
			border-bottom: 1px solid var(--border);
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 0 16px;
			z-index: 100;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
		}

		.brand {
			font-size: 20px;
			font-weight: 700;
			letter-spacing: 0.5px;
			color: var(--orange-dark);
			white-space: nowrap;
		}

		.header-right {
			display: flex;
			align-items: center;
			gap: 14px;
			font-size: 14px;
			color: var(--black);
		}

		.pill {
			background: var(--gray);
			border: 1px solid var(--border);
			border-radius: 999px;
			padding: 6px 12px;
			display: inline-flex;
			align-items: center;
			gap: 8px;
			font-weight: 600;
		}

		.profile-btn {
			cursor: pointer;
		}

		.profile-circle {
			width: 28px;
			height: 28px;
			border-radius: 50%;
			background: var(--orange);
			color: #fff;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			font-weight: 800;
			font-size: 13px;
		}

		.profile-name {
			display: none;
		}

		.profile-dropdown {
			position: absolute;
			top: 70px;
			right: 16px;
			background: #ffffff;
			border: 1px solid var(--border);
			border-radius: 12px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.12);
			padding: 10px 12px;
			min-width: 200px;
			display: none;
			z-index: 220;
		}

		.profile-dropdown.active { display: block; }

		.profile-email { color: #475569; font-size: 13px; margin: 4px 0 10px; }

		.logout-btn {
			width: 100%;
			border: 1px solid var(--border);
			border-radius: 10px;
			padding: 10px 12px;
			background: #fff7ed;
			color: var(--orange-dark);
			font-weight: 800;
			cursor: pointer;
		}

		.cart-pill {
			background: var(--orange);
			color: #ffffff;
			border: none;
		}

		.cart-button {
			cursor: pointer;
			padding: 6px 12px;
		}

		.cart-button.pulse {
			animation: pulseCart 0.4s ease;
		}

		main {
			max-width: 960px;
			margin: 0 auto;
			padding: 16px;
		}

		.category-nav {
			position: sticky;
			top: 128px;
			z-index: 120;
			background: #ffffff;
			padding: 8px 0 6px;
			margin: 0 -16px 8px;
		.item-card.unavailable {
			opacity: 0.35;
			filter: blur(2.5px);
		}
		.item-card.unavailable .add-btn {
			background: #e2e8f0;
			color: #94a3b8;
			cursor: not-allowed;
		}
		.unavailable-badge {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			padding: 6px 10px;
			border-radius: 10px;
			background: #fee2e2;
			color: #991b1b;
			font-weight: 800;
			font-size: 12px;
		}
			overflow-x: auto;
			border-bottom: 1px solid var(--border);
		}

		.category-nav-inner {
			display: inline-flex;
			gap: 8px;
			padding: 0 16px;
			white-space: nowrap;
		}

		.sub-nav {
			display: none;
			gap: 8px;
			padding: 6px 0 8px;
			margin: 0 -16px 10px;
			overflow-x: auto;
			border-bottom: 1px solid var(--border);
			background: #ffffff;
		}

		.sub-nav-inner {
			display: inline-flex;
			gap: 8px;
			padding: 0 16px;
			white-space: nowrap;
		}

		.view-categories {
			display: none;
			padding: 8px 12px;
			border: 1px solid var(--border);
			background: #fff7ed;
			color: var(--orange-dark);
			border-radius: 10px;
			font-weight: 800;
			cursor: pointer;
			margin: 4px 0 8px;
		}

		.search-bar {
			position: sticky;
			top: 76px;
			z-index: 115;
			background: #ffffff;
			padding: 8px 0;
			margin: 0 0 12px;
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
			align-items: center;
		}

		.search-input {
			flex: 1;
			padding: 10px 12px;
			border: 1px solid var(--border);
			border-radius: 10px;
			font-size: 14px;
		}

		.category-pill-btn {
			border: 1px solid var(--border);
			background: #ffffff;
			color: var(--black);
			padding: 8px 12px;
			border-radius: 999px;
			font-weight: 700;
			cursor: pointer;
			transition: background 0.18s ease, border-color 0.18s ease, color 0.18s ease;
		}

		.category-pill-btn.active {
			background: #fff7ed;
			border-color: var(--orange);
			color: var(--orange-dark);
		}

		.loading {
			display: none;
			align-items: center;
			justify-content: center;
			gap: 10px;
			color: var(--black);
			font-weight: 600;
			padding: 32px 0;
		}

		.service-overlay {
			position: fixed;
			inset: 0;
			background: rgba(0, 0, 0, 0.25);
			backdrop-filter: blur(6px);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 300;
		}

		.service-overlay.active {
			display: flex;
		}

		.service-modal {
			background: #ffffff;
			border-radius: 16px;
			padding: 22px 20px 18px;
			width: min(360px, 90vw);
			box-shadow: 0 18px 50px rgba(0, 0, 0, 0.15);
			border: 1px solid var(--border);
			text-align: center;
		}

		.service-modal h3 {
			margin: 0 0 6px;
			font-size: 18px;
			color: var(--black);
		}

		.service-modal p {
			margin: 0 0 16px;
			color: #475569;
			font-size: 14px;
		}

		.service-options {
			display: grid;
			gap: 10px;
		}

		.service-btn {
			padding: 12px;
			border-radius: 12px;
			border: 1px solid var(--border);
			background: #fff7ed;
			color: var(--orange-dark);
			font-weight: 700;
			cursor: pointer;
			transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
		}

		.service-btn:hover {
			box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
			border-color: var(--orange);
			transform: translateY(-1px);
		}

		.cart-overlay {
			position: fixed;
			inset: 0;
			background: rgba(0, 0, 0, 0.4);
			opacity: 0;
			pointer-events: none;
			transition: opacity 0.25s ease;
			z-index: 190;
		}

		.cart-overlay.active {
			opacity: 1;
			pointer-events: all;
		}

		.cart-drawer {
			position: fixed;
			inset: auto 0 0 0;
			max-height: 70vh;
			background: #ffffff;
			border-radius: 16px 16px 0 0;
			box-shadow: 0 -8px 24px rgba(0, 0, 0, 0.12);
			transform: translateY(100%);
			transition: transform 0.25s ease;
			z-index: 200;
			display: flex;
			flex-direction: column;
		}

		.cart-drawer.active {
			transform: translateY(0);
		}

		.cart-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 14px 16px;
			border-bottom: 1px solid var(--border);
			font-weight: 700;
		}

		.cart-close {
			background: transparent;
			border: none;
			font-size: 18px;
			cursor: pointer;
			color: var(--black);
		}

		.cart-items {
			overflow-y: auto;
			padding: 8px 16px 4px;
			max-height: 45vh;
		}

		.cart-row {
			display: grid;
			grid-template-columns: 1fr auto;
			gap: 8px;
			padding: 10px 0;
			border-bottom: 1px solid var(--border);
		}

		.cart-row:last-child {
			border-bottom: none;
		}

		.cart-row h4 {
			margin: 0;
			font-size: 15px;
			color: var(--black);
		}

		.cart-meta {
			font-size: 13px;
			color: #475569;
		}

		.qty-controls {
			display: inline-flex;
			align-items: center;
			gap: 8px;
			background: var(--gray);
			border-radius: 999px;
			padding: 6px 10px;
			border: 1px solid var(--border);
		}

		.qty-btn {
			width: 26px;
			height: 26px;
			border-radius: 50%;
			border: none;
			background: var(--orange);
			color: #ffffff;
			font-weight: 800;
			cursor: pointer;
			line-height: 1;
		}

		.cart-footer {
			padding: 12px 16px 18px;
			border-top: 1px solid var(--border);
			display: flex;
			align-items: center;
			justify-content: space-between;
			font-weight: 700;
		}

		.checkout-btn {
			margin: 12px 16px 18px;
			width: calc(100% - 32px);
			align-self: center;
			padding: 14px 18px;
			background: var(--orange);
			color: #ffffff;
			border: none;
			border-radius: 12px;
			font-weight: 800;
			cursor: pointer;
			transition: background 0.2s ease, transform 0.2s ease;
		}

		.checkout-btn:disabled {
			opacity: 0.6;
			cursor: not-allowed;
			transform: none;
		}

		.checkout-btn:not(:disabled):active {
			transform: scale(0.98);
		}

		.cart-empty {
			padding: 14px 16px;
			text-align: center;
			color: #475569;
			font-weight: 600;
		}

		.loading.active {
			display: flex;
		}

		.spinner {
			width: 20px;
			height: 20px;
			border-radius: 50%;
			border: 3px solid var(--orange);
			border-top-color: transparent;
			animation: spin 0.9s linear infinite;
		}

		.flying-img {
			position: fixed;
			width: 60px;
			height: 60px;
			object-fit: cover;
			border-radius: 10px;
			pointer-events: none;
			z-index: 500;
			transition: transform 0.45s ease, opacity 0.45s ease;
		}

		@keyframes spin {
			to {
				transform: rotate(360deg);
			}
		}

		@keyframes pulseCart {
			0% { transform: scale(1); }
			40% { transform: scale(1.1); }
			100% { transform: scale(1); }
		}

		.category {
			margin-bottom: 28px;
		}

		.category-title {
			font-size: 18px;
			font-weight: 800;
			color: var(--orange-dark);
			margin: 0 0 12px;
			padding: 8px 0;
			border-bottom: 2px solid var(--orange);
		}

		.item-card {
			display: flex;
			gap: 12px;
			align-items: center;
			background: #ffffff;
			border: 1px solid var(--border);
			border-radius: 12px;
			padding: 10px;
			box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
			margin-bottom: 10px;
			touch-action: manipulation;
		}

		.item-image {
			width: 88px;
			height: 88px;
			border-radius: 10px;
			object-fit: cover;
			background: var(--gray);
			flex-shrink: 0;
		}

		.item-info {
			flex: 1;
			display: flex;
			flex-direction: column;
			gap: 6px;
			min-width: 0;
		}

		.item-top {
			display: flex;
			align-items: center;
			gap: 8px;
			flex-wrap: wrap;
		}

		.item-name {
			font-size: 16px;
			font-weight: 700;
			color: var(--black);
			margin: 0;
		}

		.badge {
			display: inline-flex;
			align-items: center;
			gap: 4px;
			padding: 3px 8px;
			border-radius: 999px;
			font-size: 12px;
			font-weight: 700;
			background: rgba(249, 115, 22, 0.14);
			color: var(--orange-dark);
			border: 1px solid rgba(249, 115, 22, 0.25);
		}

		.veg-dot {
			width: 12px;
			height: 12px;
			border-radius: 50%;
			margin-right: 8px;
		}

		.veg {
			background: #22c55e;
		}

		.non-veg {
			background: #ffffff;
			border: 2px solid #f97316;
			box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.18);
		}

		.filter-btn {
			border: none;
			background: transparent;
			padding: 0;
		}

		.switch-btn {
			position: relative;
			display: inline-flex;
			align-items: center;
			gap: 10px;
			padding: 6px 10px;
			border-radius: 14px;
			border: 1px solid var(--border);
			background: #fff;
			font-weight: 800;
			color: var(--black);
			cursor: pointer;
			transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
			min-width: 148px;
		}

		.switch-btn .switch-track {
			position: relative;
			width: 54px;
			height: 28px;
			border-radius: 999px;
			background: #e2e8f0;
			border: 1px solid #cbd5e1;
			transition: background 0.2s ease, border-color 0.2s ease;
			flex-shrink: 0;
		}

		.switch-btn .switch-thumb {
			position: absolute;
			top: 3px;
			left: 3px;
			width: 22px;
			height: 22px;
			border-radius: 50%;
			background: #ffffff;
			box-shadow: 0 2px 6px rgba(0,0,0,0.12);
			transition: transform 0.2s ease, background 0.2s ease;
		}

		.switch-btn .switch-label {
			font-size: 13px;
			color: #334155;
			white-space: nowrap;
		}

		.switch-btn.switch-on {
			border-color: #fb923c;
			background: #fff7ed;
			box-shadow: 0 6px 14px rgba(249, 115, 22, 0.18);
		}

		.switch-btn.switch-on .switch-track {
			background: #fb923c;
			border-color: #f97316;
		}

		.switch-btn.switch-on .switch-thumb {
			transform: translateX(26px);
			background: #fff;
		}

		.item-desc {
			margin: 0;
			font-size: 14px;
			color: #475569;
			line-height: 1.4;
			overflow: hidden;
			text-overflow: ellipsis;
			display: -webkit-box;
			line-clamp: 3;
			-webkit-line-clamp: 3;
			-webkit-box-orient: vertical;
		}

		.item-bottom {
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 8px;
		}

		.price {
			font-weight: 800;
			color: var(--black);
			font-size: 15px;
		}

		.add-btn {
			background: var(--orange);
			color: #ffffff;
			border: none;
			padding: 12px 18px;
			border-radius: 10px;
			font-weight: 700;
			cursor: pointer;
			transition: background 0.2s ease, transform 0.2s ease;
			flex-shrink: 0;
			min-width: 88px;
			font-size: 15px;
		}

		.add-btn:active {
			transform: scale(0.98);
		}

		.add-btn:hover {
			background: var(--orange-dark);
		}

		@media (max-width: 767px) {
			.cart-button {
				position: fixed;
				bottom: 18px;
				right: 16px;
				z-index: 210;
				padding: 12px 14px;
				box-shadow: 0 10px 26px rgba(0, 0, 0, 0.16);
				border-radius: 999px;
				display: inline-flex;
				align-items: center;
				gap: 8px;
			}

			.search-input {
				font-size: 13px;
			}

			.switch-btn {
				padding: 6px 8px;
				gap: 8px;
				min-width: 138px;
			}

			.switch-btn .switch-label {
				font-size: 12px;
			}

			.category-pill-btn {
				font-size: 13px;
				padding: 7px 10px;
			}

			.item-name {
				font-size: 15px;
			}

			.price {
				font-size: 14px;
			}

			.item-desc {
				font-size: 13px;
			}

			.badge {
				font-size: 11px;
			}
		}

		.empty {
			text-align: center;
			color: #475569;
			padding: 24px 0;
			font-weight: 600;
		}

		@media (min-width: 768px) {
			header {
				padding: 0 28px;
			}

			main {
				padding: 24px;
			}

			.item-card {
				padding: 14px;
			}

			.item-image {
				width: 110px;
				height: 110px;
			}
		}
	</style>
</head>
<body>
	<header>
		<div class="brand">Ruchi's Menu</div>
		<div class="header-right">
			<div class="pill" id="table-pill">Table: <span id="table-number">-</span></div>
			<button class="pill profile-btn" id="profile-btn" type="button">
				<span class="profile-circle" id="profile-circle">A</span>
			</button>
			<button class="pill cart-pill cart-button" id="cart-button" type="button" aria-label="Cart items">
				ðŸ›’ <span id="cart-count">0</span>
			</button>
		</div>
	</header>

	<main>
		<div class="loading" id="loading">
			<div class="spinner" aria-hidden="true"></div>
			<span>Loading menu...</span>
		</div>
		<div class="search-bar" id="search-bar" style="display:none;">
			<input class="search-input" id="menu-search" type="search" placeholder="Search menu..." aria-label="Search menu" />
			<button class="filter-btn switch-btn" id="veg-toggle" type="button" aria-pressed="false">
				<span class="switch-track" aria-hidden="true">
					<span class="switch-thumb"></span>
				</span>
				<span class="switch-label">Veg filter off</span>
			</button>
			<button class="filter-btn switch-btn" id="available-toggle" type="button" aria-pressed="false">
				<span class="switch-track" aria-hidden="true">
					<span class="switch-thumb"></span>
				</span>
				<span class="switch-label">Available now</span>
			</button>
		</div>
		<div class="category-nav" id="category-nav" style="display:none;">
			<div class="category-nav-inner" id="category-nav-inner"></div>
		</div>
		<button class="view-categories" id="view-categories" type="button" style="display:none;">View Categories</button>
		<div class="sub-nav" id="sub-nav">
			<div class="sub-nav-inner" id="sub-nav-inner"></div>
		</div>
		<div id="menu-container"></div>
	</main>

	<div class="service-overlay" id="service-overlay">
		<div class="service-modal" role="dialog" aria-modal="true" aria-labelledby="service-title">
			<h3 id="service-title">Choose Service Type</h3>
			<p>Please select how you would like to proceed.</p>
			<div class="service-options">
				<button class="service-btn" data-service="dine-in" type="button">Dine In</button>
				<button class="service-btn" data-service="takeaway" type="button">Take Away</button>
				<button class="service-btn" data-service="pickup" type="button">Pick Up</button>
			</div>
		</div>
	</div>

	<div class="cart-overlay" id="cart-overlay"></div>
	<div class="cart-drawer" id="cart-drawer" aria-label="Cart drawer">
		<div class="cart-header">
			<span>Cart</span>
			<button class="cart-close" id="close-cart" aria-label="Close cart">âœ•</button>
		</div>
		<div class="cart-items" id="cart-items"></div>
		<div class="cart-footer">
			<span>Total</span>
			<span id="cart-total">RM 0.00</span>
		</div>
		<button class="checkout-btn" id="checkout-btn" type="button">Checkout</button>
	</div>

	<div class="profile-dropdown" id="profile-dropdown">
		<div style="font-weight:800;" id="profile-display">Signed in</div>
		<div class="profile-email" id="profile-email">-</div>
		<button class="logout-btn" id="logout-btn" type="button">Log out</button>
		<button class="logout-btn" id="login-btn" type="button" style="display:none; margin-top:8px;">Sign in</button>
	</div>

	<script type="module">
		import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
		import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
		import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

		const firebaseConfig = {
			apiKey: "AIzaSyCS1WJJQ7QQnqRhtwuTQCPpjjb3tIjQ3nQ",
			authDomain: "ruchi-53a14.firebaseapp.com",
			projectId: "ruchi-53a14",
			storageBucket: "ruchi-53a14.firebasestorage.app",
			messagingSenderId: "473906899822",
			appId: "1:473906899822:web:07640feeca4e379aaa6f7f",
			measurementId: "G-J1CQDC048C"
		};

		const app = initializeApp(firebaseConfig);
		const db = getFirestore(app);
		const auth = getAuth(app);

		const tableNumberSpan = document.getElementById("table-number");
		const cartCountSpan = document.getElementById("cart-count");
		const menuContainer = document.getElementById("menu-container");
		const loadingEl = document.getElementById("loading");
		const cartButton = document.getElementById("cart-button");
		const cartOverlay = document.getElementById("cart-overlay");
		const cartDrawer = document.getElementById("cart-drawer");
		const closeCartBtn = document.getElementById("close-cart");
		const cartItemsEl = document.getElementById("cart-items");
		const cartTotalEl = document.getElementById("cart-total");
		const checkoutBtn = document.getElementById("checkout-btn");
		const serviceOverlay = document.getElementById("service-overlay");
		const serviceButtons = serviceOverlay.querySelectorAll(".service-btn");
		const categoryNav = document.getElementById("category-nav");
		const categoryNavInner = document.getElementById("category-nav-inner");
		const headerEl = document.querySelector("header");
		const profileBtn = document.getElementById("profile-btn");
		const profileDropdown = document.getElementById("profile-dropdown");
		const profileDisplay = document.getElementById("profile-display");
		const profileEmail = document.getElementById("profile-email");
		const profileCircle = document.getElementById("profile-circle");
		const profileName = document.getElementById("profile-name");
		const logoutBtn = document.getElementById("logout-btn");
		const loginBtn = document.getElementById("login-btn");
		const guestLabel = "Guest";
		const guestEmail = "Continuing as guest";
		const searchBar = document.getElementById("search-bar");
		const searchInput = document.getElementById("menu-search");
		const vegToggle = document.getElementById("veg-toggle");
		const availableToggle = document.getElementById("available-toggle");
		const viewCategoriesBtn = document.getElementById("view-categories");
		const subNav = document.getElementById("sub-nav");
		const subNavInner = document.getElementById("sub-nav-inner");
		const genericErrorHtml = '<div class="empty">Unable to load menu. Please check your internet connection or permissions and try again.</div>';
		let checkoutPending = false;
		let allItems = [];
		let profileOpen = false;
		let vegOnly = false;
		let availableOnly = false;
		let activeMain = "All";
		let autoMainSet = false;
		let mainManuallySelected = false;
		let subNavVisible = false;
		let menuUnsub = null;
		let scheduleIntervalId = null;

		const urlParams = new URLSearchParams(window.location.search);
		const tableNumber = urlParams.get("table") || "1";
		const cartKey = `cart_table${tableNumber}`;
		const serviceKey = `service_choice_table${tableNumber}`;

		const CATEGORY_MAP = {
			Breakfast: ["Chapati", "Dosa", "Egg Options", "Idly", "Nasi Lemak", "Roti Canai", "Roti Varieties"],
			Lunch: ["Add On", "Banana Leaf", "Banana Leaf Meal", "Briyani", "Biryani", "Chapati", "Chicken Options", "Claypot", "Egg Options", "Mutton Options", "Seafood Options"],
			Dinner: ["Chapati", "Claypot", "Dosa", "Egg Options", "Finger Foods", "Goreng", "Nasi Lemak", "Parotta", "Rolls", "Roti Canai", "Roti Varieties", "Sandwich", "Chicken Special"],
			Drinks: ["Coffee", "Juices", "Lassi", "Milk Drinks", "Tea"],
		};

		const MAIN_CATEGORIES = ["All", "Breakfast", "Lunch", "Dinner", "Drinks"];
		const SUBCATEGORY_ORDER = {
			All: ["Banana Leaf", "Banana Leaf Meal", "Claypot", "Briyani", "Biryani"],
			Lunch: ["Banana Leaf", "Banana Leaf Meal", "Claypot", "Briyani", "Biryani"],
		};
		const MALAYSIA_TZ = "Asia/Kuala_Lumpur";
		const timeStringToMinutes = (value = "00:00") => {
			const [hourRaw, minuteRaw] = value.split(":");
			return Number(hourRaw || 0) * 60 + Number(minuteRaw || 0);
		};

		const getMalaysiaMinutes = () => {
			const parts = new Intl.DateTimeFormat("en-GB", { timeZone: MALAYSIA_TZ, hour: "2-digit", minute: "2-digit", hour12: false }).formatToParts(new Date());
			const hour = Number(parts.find((p) => p.type === "hour")?.value || 0);
			const minute = Number(parts.find((p) => p.type === "minute")?.value || 0);
			return hour * 60 + minute;
		};

		const formatMinutesTo12h = (totalMinutes = 0) => {
			const minutes = Math.max(0, totalMinutes);
			const hour24 = Math.floor(minutes / 60) % 24;
			const minute = minutes % 60;
			const suffix = hour24 >= 12 ? "PM" : "AM";
			const hour12 = hour24 % 12 || 12;
			return `${hour12}:${minute.toString().padStart(2, "0")} ${suffix}`;
		};

		const makeWindow = (startStr, endStr) => {
			const start = timeStringToMinutes(startStr);
			const end = timeStringToMinutes(endStr);
			return { start, end, label: `${formatMinutesTo12h(start)} - ${formatMinutesTo12h(end)}` };
		};

		const TIME_WINDOWS = {
			Breakfast: makeWindow("07:00", "11:30"),
			Lunch: makeWindow("11:30", "16:00"),
			Dinner: makeWindow("16:00", "22:00"),
		};

		const getMainCategoryForTime = (minutes) => {
			if (isWithinWindow(minutes, TIME_WINDOWS.Breakfast)) return "Breakfast";
			if (isWithinWindow(minutes, TIME_WINDOWS.Lunch)) return "Lunch";
			if (isWithinWindow(minutes, TIME_WINDOWS.Dinner)) return "Dinner";
			return "Dinner";
		};

		const isWithinWindow = (minutes, window) => minutes >= window.start && minutes < window.end;
		const subToMain = (() => {
			const map = {};
			Object.entries(CATEGORY_MAP).forEach(([main, subs]) => {
				subs.forEach((sub) => {
					const key = (sub || "").toLowerCase();
					if (!map[key]) map[key] = [];
					map[key].push(main);
				});
			});
			return map;
		})();

		const getSubcategoryWindows = (label) => {
			const key = (label || "").trim().toLowerCase();
			const mains = subToMain[key] || [];
			if (mains.includes("Drinks")) return [];
			const windows = mains.map((main) => TIME_WINDOWS[main]).filter(Boolean);
			if (windows.length) return windows;
			return Object.values(TIME_WINDOWS);
		};

		const isSubcategoryAvailableNow = (label, currentMinutes) => {
			const windows = getSubcategoryWindows(label);
			if (!windows.length) return true;
			return windows.some((win) => isWithinWindow(currentMinutes, win));
		};

		const getSubcategoryWindowLabels = (label) => {
			const windows = getSubcategoryWindows(label);
			if (!windows.length) return null;
			const seen = new Set();
			const labels = [];
			windows.forEach((win) => {
				if (!win?.label || seen.has(win.label)) return;
				seen.add(win.label);
				labels.push(win.label);
			});
			return labels;
		};

		const getAvailabilityMessage = (label) => {
			const labels = getSubcategoryWindowLabels(label);
			if (!labels || !labels.length) return null;
			return `Available ${labels.join(" / ")} (MYT)`;
		};

		const syncActiveMainWithTime = (currentMinutes = getMalaysiaMinutes()) => {
			if (mainManuallySelected) return;
			const inferred = getMainCategoryForTime(currentMinutes);
			if (inferred && MAIN_CATEGORIES.includes(inferred)) {
				activeMain = inferred;
				autoMainSet = true;
			}
		};

		tableNumberSpan.textContent = tableNumber;

		const getCart = () => {
			try {
				const stored = localStorage.getItem(cartKey);
				return stored ? JSON.parse(stored) : [];
			} catch (err) {
				console.error("Failed to read cart", err);
				return [];
			}
		};

		const saveCart = (cart) => {
			localStorage.setItem(cartKey, JSON.stringify(cart));
		};

		const clearCart = () => {
			saveCart([]);
			updateCartCount();
			renderCartDrawer();
		};

		const formatPrice = (value) => `RM ${Number(value || 0).toFixed(2)}`;
		const vegPrefKey = `veg_only_filter_${tableNumber}`;
		const availablePrefKey = `available_only_filter_${tableNumber}`;

		const normalizeSubcategory = (raw) => {
			const cleaned = (raw || "").trim();
			if (!cleaned) return "General";
			const lower = cleaned.toLowerCase();
			if (lower === "others" || lower === "other") return "General";
			return cleaned;
		};

		const getScrollOffset = () => {
			const headerHeight = headerEl?.offsetHeight || 0;
			const searchHeight = searchBar?.offsetHeight || 0;
			const categoryHeight = categoryNav?.offsetHeight || 0;
			return headerHeight + searchHeight + categoryHeight + 12;
		};

		const setServiceChoice = (choice) => {
			localStorage.setItem(serviceKey, choice);
		};

		const getServiceChoice = () => {
			try {
				return localStorage.getItem(serviceKey);
			} catch (e) {
				return null;
			}
		};

		const animateToCart = (imgEl) => {
			if (!imgEl) return;
			const rect = imgEl.getBoundingClientRect();
			const cartRect = cartButton.getBoundingClientRect();

			const clone = imgEl.cloneNode(true);
			clone.classList.add("flying-img");
			clone.style.top = `${rect.top}px`;
			clone.style.left = `${rect.left}px`;
			clone.style.width = `${rect.width}px`;
			clone.style.height = `${rect.height}px`;
			clone.style.transition = "transform 0.35s ease, opacity 0.35s ease";
			document.body.appendChild(clone);

			const cx = rect.left + rect.width / 2;
			const cy = rect.top + rect.height / 2;
			const midX = window.innerWidth / 2;
			const midY = window.innerHeight / 2;

			requestAnimationFrame(() => {
				const dxMid = midX - cx;
				const dyMid = midY - cy;
				clone.style.transform = `translate(${dxMid}px, ${dyMid}px) scale(0.75)`;
			});

			const flyToCart = () => {
				clone.removeEventListener("transitionend", flyToCart);
				setTimeout(() => {
					clone.style.transition = "transform 0.35s ease, opacity 0.35s ease";
					const dx = cartRect.left + cartRect.width / 2 - cx;
					const dy = cartRect.top + cartRect.height / 2 - cy;
					requestAnimationFrame(() => {
						clone.style.transform = `translate(${dx}px, ${dy}px) scale(0.3)`;
						clone.style.opacity = "0";
					});
					clone.addEventListener("transitionend", () => {
						clone.remove();
						cartButton.classList.remove("pulse");
						void cartButton.offsetWidth; // restart animation
						cartButton.classList.add("pulse");
					}, { once: true });
				}, 800); // pause in middle
			};

			clone.addEventListener("transitionend", flyToCart, { once: true });
		};

		const updateCartCount = () => {
			const cart = getCart();
			const total = cart.reduce((sum, item) => sum + (item.qty || 0), 0);
			cartCountSpan.textContent = total;
		};

		const addToCart = (item) => {
			const cart = getCart();
			const existing = cart.find((c) => c.id === item.id);
			if (existing) {
				existing.qty += 1;
			} else {
				cart.push({ ...item, qty: 1 });
			}
			saveCart(cart);
			updateCartCount();
			renderCartDrawer();
		};

		const changeQty = (id, delta) => {
			const cart = getCart();
			const item = cart.find((c) => c.id === id);
			if (!item) return;
			item.qty += delta;
			if (item.qty <= 0) {
				const idx = cart.findIndex((c) => c.id === id);
				if (idx >= 0) cart.splice(idx, 1);
			}
			saveCart(cart);
			updateCartCount();
			renderCartDrawer();
		};

		const renderCartDrawer = () => {
			const cart = getCart();
			if (!cart.length) {
				cartItemsEl.innerHTML = '<div class="cart-empty">Your cart is empty.</div>';
				cartTotalEl.textContent = formatPrice(0);
				checkoutBtn.disabled = true;
				return;
			}

			cartItemsEl.innerHTML = "";
			let total = 0;

			cart.forEach((item) => {
				const row = document.createElement("div");
				row.className = "cart-row";

				const left = document.createElement("div");
				const title = document.createElement("h4");
				title.textContent = item.name || "Item";
				const meta = document.createElement("div");
				meta.className = "cart-meta";
				meta.textContent = formatPrice(item.price || 0);
				left.appendChild(title);
				left.appendChild(meta);

				const controls = document.createElement("div");
				controls.className = "qty-controls";

				const minus = document.createElement("button");
				minus.className = "qty-btn";
				minus.type = "button";
				minus.textContent = "-";
				minus.addEventListener("click", () => changeQty(item.id, -1));

				const qty = document.createElement("span");
				qty.textContent = item.qty || 0;

				const plus = document.createElement("button");
				plus.className = "qty-btn";
				plus.type = "button";
				plus.textContent = "+";
				plus.addEventListener("click", () => changeQty(item.id, 1));

				controls.appendChild(minus);
				controls.appendChild(qty);
				controls.appendChild(plus);

				row.appendChild(left);
				row.appendChild(controls);

				cartItemsEl.appendChild(row);

				total += (item.price || 0) * (item.qty || 0);
			});

			cartTotalEl.textContent = formatPrice(total);
			checkoutBtn.disabled = false;
		};

		const goToCheckout = () => {
			checkoutPending = true;
			showServiceModal();
		};

		const openCart = () => {
			renderCartDrawer();
			cartOverlay.classList.add("active");
			cartDrawer.classList.add("active");
		};

		const closeCart = () => {
			cartOverlay.classList.remove("active");
			cartDrawer.classList.remove("active");
		};

		const renderMenu = (items) => {
			menuContainer.innerHTML = "";
			categoryNavInner.innerHTML = "";
			subNavInner.innerHTML = "";
			categoryNav.style.display = "none";
			subNav.style.display = "none";
			viewCategoriesBtn.style.display = "none";

			if (!items.length) {
				menuContainer.innerHTML = '<div class="empty">No menu items available right now.</div>';
				return;
			}

			const nowMalaysiaMinutes = getMalaysiaMinutes();

			const groupedByMain = { All: {} };
			const pushItem = (mainKey, subKey, itm) => {
				const main = MAIN_CATEGORIES.includes(mainKey) ? mainKey : activeMain;
				const sub = subKey || "Others";
				if (!groupedByMain[main]) groupedByMain[main] = {};
				if (!groupedByMain[main][sub]) groupedByMain[main][sub] = [];
				groupedByMain[main][sub].push(itm);
			};

			items.forEach((item) => {
				const rawSub = item.category;
				const subLabel = normalizeSubcategory(rawSub);
				pushItem("All", subLabel, item);

				const mapped = subToMain[subLabel.toLowerCase()];
				const hasMapping = Array.isArray(mapped) && mapped.length;
				if (hasMapping) {
					mapped.forEach((mainCat) => pushItem(mainCat, subLabel, item));
				}
			});

			categoryNav.style.display = "block";
			categoryNavInner.innerHTML = "";
			const mainFrag = document.createDocumentFragment();
			MAIN_CATEGORIES.forEach((main) => {
				const btn = document.createElement("button");
				btn.className = "category-pill-btn";
				btn.textContent = main;
				btn.classList.toggle("active", main === activeMain);
				btn.addEventListener("click", () => {
					activeMain = main;
					mainManuallySelected = true;
					subNavVisible = false;
					renderMenu(items);
				});
				mainFrag.appendChild(btn);
			});
			categoryNavInner.appendChild(mainFrag);

			const activeGroups = groupedByMain[activeMain] || {};
			const subOrder = SUBCATEGORY_ORDER[activeMain] || [];
			const rank = (label) => {
				const idx = subOrder.findIndex((v) => v.toLowerCase() === (label || "").toLowerCase());
				return idx === -1 ? Number.POSITIVE_INFINITY : idx;
			};
			const subCategories = Object.keys(activeGroups).sort((a, b) => {
				const ra = rank(a);
				const rb = rank(b);
				if (ra !== rb) return ra - rb;
				return a.localeCompare(b, "en", { sensitivity: "base" });
			});
			viewCategoriesBtn.style.display = subCategories.length ? "inline-flex" : "none";
			viewCategoriesBtn.textContent = subNavVisible ? "Hide Categories" : "View Categories";
			const sectionFrag = document.createDocumentFragment();
			const sectionIds = [];

			subCategories.forEach((subCat) => {
				const itemsInSub = (activeGroups[subCat] || []).slice().sort((a, b) => (a.name || "").localeCompare(b.name || "", "en", { sensitivity: "base" }));
				if (!itemsInSub.length) return;
				const sectionId = `cat-${(subCat || "others").toLowerCase().replace(/[^a-z0-9]+/g, "-") || "others"}`;
				sectionIds.push({ id: sectionId, label: subCat });

				const section = document.createElement("section");
				section.className = "category";
				section.id = sectionId;
				section.style.scrollMarginTop = `${getScrollOffset()}px`;

				const title = document.createElement("h2");
				title.className = "category-title";
				title.textContent = subCat;
				section.appendChild(title);

				itemsInSub.forEach((item) => {
						const categoryLabel = subCat;
						const timeWindows = getSubcategoryWindows(categoryLabel);
						const timeBlocked = timeWindows.length > 0 && !isSubcategoryAvailableNow(categoryLabel, nowMalaysiaMinutes);
						const card = document.createElement("div");
						card.className = "item-card";

						const img = document.createElement("img");
						img.className = "item-image";
						const imageSrc = item.image || item.imageURL || "https://via.placeholder.com/120x120?text=No+Image";
						img.src = imageSrc;
						img.alt = item.name || "Menu item";
						img.loading = "lazy";
						img.decoding = "async";

						const info = document.createElement("div");
						info.className = "item-info";

						const topRow = document.createElement("div");
						topRow.className = "item-top";

						const nameEl = document.createElement("h3");
						nameEl.className = "item-name";
						nameEl.textContent = item.name || "Unnamed Item";

						const vegBadge = document.createElement("span");
						const isVeg = Boolean(item.veg);
						vegBadge.className = `veg-dot ${isVeg ? "veg" : "non-veg"}`;
						vegBadge.title = isVeg ? "Veg" : "Non-Veg";

						topRow.appendChild(vegBadge);
						topRow.appendChild(nameEl);

						const mostOrdered = Boolean(item.bestseller) || categoryLabel.toLowerCase() === "banana leaf meal";
						if (mostOrdered) {
							const best = document.createElement("span");
							best.className = "badge";
							best.textContent = "Most ordered â˜…";
							topRow.appendChild(best);
						}

						const desc = document.createElement("p");
						desc.className = "item-desc";
						desc.textContent = item.description || "Delicious item from our kitchen.";

						const bottomRow = document.createElement("div");
						bottomRow.className = "item-bottom";

						const price = document.createElement("div");
						price.className = "price";
						price.textContent = item.price !== undefined ? `RM ${Number(item.price).toFixed(2)}` : "Price on request";

						const unavailable = item.available === false || timeBlocked;
						if (availableOnly && unavailable) return;
						if (unavailable) card.classList.add("unavailable");

						const addBtn = document.createElement("button");
						addBtn.className = "add-btn";
						addBtn.type = "button";
						addBtn.textContent = unavailable ? "Not available" : "Add";
						addBtn.disabled = unavailable;
						addBtn.addEventListener("click", (event) => {
							event.stopPropagation();
							if (unavailable) return;
							animateToCart(img);
							addToCart({
								id: item.id,
								name: item.name,
								price: Number(item.price) || 0,
								image: imageSrc,
							});
						});

						card.style.cursor = unavailable ? "not-allowed" : "pointer";
						card.addEventListener("click", () => {
							if (unavailable) return;
							const params = new URLSearchParams({
								id: item.id,
								name: item.name || "",
								price: item.price !== undefined ? item.price : 0,
								image: imageSrc,
								category: item.category || "",
								table: tableNumber,
							});
							window.location.href = `item.html?${params.toString()}`;
						});

						if (unavailable) {
							const unavailableTag = document.createElement("span");
							unavailableTag.className = "unavailable-badge";
							const availability = getAvailabilityMessage(categoryLabel);
							if (timeBlocked && availability) {
								unavailableTag.textContent = availability;
							} else if (timeBlocked) {
								unavailableTag.textContent = "Available later today";
							} else {
								unavailableTag.textContent = "Not available";
							}
							bottomRow.appendChild(unavailableTag);
						}
						bottomRow.appendChild(price);
						bottomRow.appendChild(addBtn);

						info.appendChild(topRow);
						info.appendChild(desc);
						info.appendChild(bottomRow);

						card.appendChild(img);
						card.appendChild(info);

						section.appendChild(card);
					});

				if (section.querySelector(".item-card")) {
					sectionFrag.appendChild(section);
				}
			});

			menuContainer.appendChild(sectionFrag);

			if (!subCategories.length) {
				menuContainer.innerHTML = '<div class="empty">No items for this category.</div>';
			}

			if (subCategories.length) {
				subNav.style.display = subNavVisible ? "flex" : "none";
				subNavInner.innerHTML = "";
				const subFrag = document.createDocumentFragment();
				subCategories.forEach((label, idx) => {
					const btn = document.createElement("button");
					btn.className = "category-pill-btn";
					btn.textContent = label;
					btn.setAttribute("data-target", `cat-${(label || "others").toLowerCase().replace(/[^a-z0-9]+/g, "-") || "others"}`);
					btn.addEventListener("click", () => {
						const target = document.getElementById(btn.getAttribute("data-target"));
						if (!target) return;
						const headerOffset = getScrollOffset();
						const top = target.getBoundingClientRect().top + window.scrollY - headerOffset;
						window.scrollTo({ top, behavior: "smooth" });
					});
					if (idx === 0) btn.classList.add("active");
					subFrag.appendChild(btn);
				});
				subNavInner.appendChild(subFrag);
			}

			if (sectionIds.length && subNavVisible) {
				const observerOffset = getScrollOffset() + 10;
				const observer = new IntersectionObserver((entries) => {
					entries.forEach((entry) => {
						const id = entry.target.id;
						const btn = subNavInner.querySelector(`[data-target="${id}"]`);
						if (btn && entry.isIntersecting) {
							subNavInner.querySelectorAll(".category-pill-btn").forEach((b) => b.classList.remove("active"));
							btn.classList.add("active");
							const parent = subNavInner.parentElement;
							if (parent) {
								const targetX = btn.offsetLeft - 40;
								parent.scrollTo({ left: targetX < 0 ? 0 : targetX, behavior: "smooth" });
							}
						}
					});
				}, { root: null, rootMargin: `-${observerOffset}px 0px -60% 0px`, threshold: [0, 0.25, 0.5] });

				sectionIds.forEach(({ id }) => {
					const el = document.getElementById(id);
					if (el) observer.observe(el);
				});
			}
		};

		const setSwitchState = (btn, on, onLabel, offLabel) => {
			if (!btn) return;
			const labelEl = btn.querySelector(".switch-label");
			if (labelEl) labelEl.textContent = on ? onLabel : offLabel;
			btn.classList.toggle("switch-on", on);
			btn.setAttribute("aria-pressed", String(on));
		};

		const applyVegToggleState = () => {
			vegOnly = localStorage.getItem(vegPrefKey) === "1";
			setSwitchState(vegToggle, vegOnly, "Veg filter on", "Veg filter off");
		};

		const applyAvailableToggleState = () => {
			availableOnly = localStorage.getItem(availablePrefKey) === "1";
			setSwitchState(availableToggle, availableOnly, "Available now", "Available now");
		};

		const filteredItems = () => {
			const term = (searchInput.value || "").trim().toLowerCase();
			return allItems.filter((item) => {
				if (vegOnly && !item.veg) return false;
				if (!term) return true;
				const name = (item.name || "").toLowerCase();
				const desc = (item.description || "").toLowerCase();
				const cat = (item.category || "").toLowerCase();
				return name.includes(term) || desc.includes(term) || cat.includes(term);
			});
		};

		const startMenuListener = () => {
			loadingEl.classList.add("active");
			if (menuUnsub) menuUnsub();
			menuUnsub = onSnapshot(collection(db, "menuItems"), (snap) => {
				allItems = snap.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
				const nowMinutes = getMalaysiaMinutes();
				applyVegToggleState();
				applyAvailableToggleState();
				syncActiveMainWithTime(nowMinutes);
				renderMenu(filteredItems());
				searchBar.style.display = "flex";
				loadingEl.classList.remove("active");
				if (!scheduleIntervalId) {
					scheduleIntervalId = setInterval(() => {
						syncActiveMainWithTime(getMalaysiaMinutes());
						renderMenu(filteredItems());
					}, 60000);
				}
			}, (error) => {
				loadingEl.classList.remove("active");
				console.error("Error loading menu", error);
				const message = error?.code === "permission-denied"
					? '<div class="empty">Access denied: Firestore rules are blocking reads. Please allow reads for the menu or sign in with an authorized user.</div>'
					: genericErrorHtml;
				menuContainer.innerHTML = message;
			});
		};

		const handleSearch = () => {
			renderMenu(filteredItems());
		};

		const showServiceModal = () => {
			serviceOverlay.classList.add("active");
			document.body.classList.add("modal-open");
		};

		const toggleProfileDropdown = () => {
			if (!profileDropdown) return;
			profileOpen = !profileOpen;
			profileDropdown.classList.toggle("active", profileOpen);
		};

		const closeProfileDropdown = () => {
			if (!profileDropdown) return;
			profileOpen = false;
			profileDropdown.classList.remove("active");
		};

		const hideServiceModal = () => {
			serviceOverlay.classList.remove("active");
			document.body.classList.remove("modal-open");
		};

		logoutBtn?.addEventListener("click", async () => {
			try {
				await signOut(auth);
				window.location.href = "login.html";
			} catch (err) {
				console.error("Failed to sign out", err);
			}
		});

		loginBtn?.addEventListener("click", () => {
			window.location.href = "login.html";
		});

		profileBtn?.addEventListener("click", (event) => {
			event.stopPropagation();
			toggleProfileDropdown();
		});

		document.addEventListener("click", (event) => {
			if (!profileDropdown || !profileBtn) return;
			if (profileOpen && !profileDropdown.contains(event.target) && !profileBtn.contains(event.target)) {
				closeProfileDropdown();
			}
		});

		onAuthStateChanged(auth, (user) => {
			const displayName = user?.displayName || user?.email?.split("@")[0] || guestLabel;
			const email = user?.email || guestEmail;
			profileDisplay.textContent = displayName;
			profileEmail.textContent = email;
			if (profileName) profileName.textContent = displayName;
			profileCircle.textContent = (displayName[0] || "?").toUpperCase();
			if (logoutBtn) logoutBtn.style.display = user ? "block" : "none";
			if (loginBtn) loginBtn.style.display = user ? "none" : "block";
		});

		serviceButtons.forEach((btn) => {
			btn.addEventListener("click", () => {
				const choice = btn.getAttribute("data-service");
				setServiceChoice(choice);
				hideServiceModal();
				if (checkoutPending) {
					checkoutPending = false;
					const params = new URLSearchParams({ table: tableNumber, service: choice });
					window.location.href = `summary.html?${params.toString()}`;
				}
			});
		});

		searchInput.addEventListener("input", handleSearch);

		vegToggle?.addEventListener("click", () => {
			vegOnly = !vegOnly;
			localStorage.setItem(vegPrefKey, vegOnly ? "1" : "0");
			applyVegToggleState();
			renderMenu(filteredItems());
		});

		availableToggle?.addEventListener("click", () => {
			availableOnly = !availableOnly;
			localStorage.setItem(availablePrefKey, availableOnly ? "1" : "0");
			applyAvailableToggleState();
			renderMenu(filteredItems());
		});

		viewCategoriesBtn?.addEventListener("click", () => {
			subNavVisible = !subNavVisible;
			viewCategoriesBtn.textContent = subNavVisible ? "Hide Categories" : "View Categories";
			renderMenu(filteredItems());
		});

		cartButton.addEventListener("click", openCart);
		cartOverlay.addEventListener("click", closeCart);
		closeCartBtn.addEventListener("click", closeCart);
		checkoutBtn.addEventListener("click", goToCheckout);

		updateCartCount();
		renderCartDrawer();
		window.addEventListener("pageshow", () => {
			updateCartCount();
			renderCartDrawer();
		});
		startMenuListener();
	</script>
</body>
</html>
