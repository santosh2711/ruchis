<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>RUCHI | Item</title>
	<style>
		:root {
			--orange: #f97316;
			--orange-dark: #ea580c;
			--bg: #ffffff;
			--panel: #ffffff;
			--border: #e2e8f0;
			--text: #0f172a;
			--muted: #475569;
		}

		* { box-sizing: border-box; }

		body {
			margin: 0;
			font-family: "Segoe UI", Tahoma, sans-serif;
			background: var(--bg);
			color: var(--text);
			min-height: 100vh;
		}

		header {
			position: sticky;
			top: 0;
			z-index: 10;
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 14px 16px;
			background: #ffffff;
			border-bottom: 1px solid var(--border);
			box-shadow: 0 2px 10px rgba(0,0,0,0.04);
		}

		.brand {
			font-weight: 800;
			color: var(--orange-dark);
			font-size: 18px;
		}

		.pill {
			background: #fff7ed;
			border: 1px solid var(--border);
			border-radius: 999px;
			padding: 8px 12px;
			font-weight: 700;
			color: var(--text);
		}

		main {
			max-width: 720px;
			margin: 0 auto;
			padding: 16px;
		}

		.card {
			background: var(--panel);
			border: 1px solid var(--border);
			border-radius: 18px;
			overflow: hidden;
			box-shadow: 0 14px 38px rgba(0,0,0,0.08);
		}

		.hero {
			position: relative;
			width: 100%;
			height: 260px;
			overflow: hidden;
			background: #0b0b0b;
		}

		.hero img {
			width: 100%;
			height: 100%;
			object-fit: cover;
			display: block;
		}

		.sheet {
			padding: 18px 16px 24px;
		}

		.title-row {
			display: flex;
			justify-content: space-between;
			align-items: flex-start;
			gap: 12px;
		}

		h1 {
			margin: 0;
			font-size: 22px;
			font-weight: 800;
		}

		.price {
			margin: 0;
			font-size: 18px;
			font-weight: 800;
			color: var(--orange-dark);
		}

		.subtitle {
			margin: 6px 0 16px;
			color: var(--muted);
			font-weight: 600;
		}

		.label-row {
			display: flex;
			align-items: center;
			justify-content: space-between;
			margin-bottom: 6px;
		}

		.label {
			color: var(--text);
			font-weight: 700;
		}

		.optional {
			color: var(--muted);
			font-weight: 700;
			font-size: 12px;
		}

		textarea {
			width: 100%;
			min-height: 120px;
			background: #f8fafc;
			color: var(--text);
			border: 1px solid var(--border);
			border-radius: 12px;
			padding: 12px;
			font-size: 14px;
			resize: vertical;
			outline: none;
		}

		textarea::placeholder { color: var(--muted); }

		.qty-row {
			margin: 18px 0;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 18px;
		}

		.qty-btn {
			width: 48px;
			height: 48px;
			border-radius: 50%;
			border: none;
			background: var(--orange);
			color: #ffffff;
			font-size: 22px;
			font-weight: 800;
			cursor: pointer;
			transition: transform 0.15s ease, background 0.15s ease;
		}

		.qty-btn:active { transform: scale(0.96); }
		.qty-btn:hover { background: var(--orange-dark); }

		.qty-val {
			min-width: 30px;
			text-align: center;
			font-size: 18px;
			font-weight: 700;
		}

		.add-btn {
			margin-top: 12px;
			width: 100%;
			border: none;
			border-radius: 12px;
			background: var(--orange);
			color: #ffffff;
			font-size: 16px;
			font-weight: 800;
			padding: 15px;
			cursor: pointer;
			box-shadow: 0 12px 30px rgba(234, 88, 12, 0.18);
			transition: background 0.15s ease, transform 0.15s ease;
		}

		.add-btn:active { transform: translateY(1px); }
		.add-btn:hover { background: var(--orange-dark); }

		@media (min-width: 640px) {
			main { padding: 24px; }
			.card { border-radius: 20px; }
			.hero { height: 320px; }
		}
	</style>
</head>
<body>
	<header>
		<div class="brand">Ruchi</div>
		<div class="pill">Table: <span id="table-number">-</span></div>
	</header>

	<main>
		<div class="card">
			<div class="hero" aria-hidden="true">
				<img id="item-image" src="" alt="Food image" />
			</div>
			<div class="sheet">
				<div class="title-row">
					<h1 id="item-name">Item</h1>
					<p class="price" id="item-price">RM 0.00</p>
				</div>
				<p class="subtitle" id="item-category">-</p>

				<div class="label-row">
					<span class="label">Note to restaurant</span>
					<span class="optional">Optional</span>
				</div>
				<textarea id="note" placeholder="Add note! eg. No onions, extra spicy"></textarea>

				<div class="qty-row">
					<button class="qty-btn" id="dec" type="button" aria-label="Decrease quantity">-</button>
					<div class="qty-val" id="qty-val">1</div>
					<button class="qty-btn" id="inc" type="button" aria-label="Increase quantity">+</button>
				</div>

				<button class="add-btn" id="add-btn" type="button">Add to cart</button>
			</div>
		</div>
	</main>

	<script>
		// Parse URL params for item details
		const params = new URLSearchParams(window.location.search);
		const itemId = params.get("id") || "";
		const itemName = params.get("name") || "Item";
		const itemPrice = parseFloat(params.get("price")) || 0;
		const itemImage = params.get("image") || "https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=900&q=80";
		const itemCategory = params.get("category") || "";
		const itemNote = params.get("note") || "";
		const cartUid = params.get("cartUid") || "";
		const table = params.get("table") || "1";

		const genUid = () => `uid-${Date.now()}-${Math.random().toString(16).slice(2)}`;

		const imgEl = document.getElementById("item-image");
		const nameEl = document.getElementById("item-name");
		const priceEl = document.getElementById("item-price");
		const categoryEl = document.getElementById("item-category");
		const noteEl = document.getElementById("note");
		const qtyVal = document.getElementById("qty-val");
		const decBtn = document.getElementById("dec");
		const incBtn = document.getElementById("inc");
		const addBtn = document.getElementById("add-btn");
		const tableNumberEl = document.getElementById("table-number");

		const CART_KEY = `cart_table${table}`;

		const loadCart = () => {
			try {
				const stored = localStorage.getItem(CART_KEY);
				return stored ? JSON.parse(stored) : [];
			} catch (e) {
				return [];
			}
		};

		const saveCart = (cart) => {
			localStorage.setItem(CART_KEY, JSON.stringify(cart));
		};

		const cart = loadCart();
		let editingIndex = -1;
		if (cartUid) {
			editingIndex = cart.findIndex((i) => i.uid === cartUid);
		}
		const editingItem = editingIndex >= 0 ? cart[editingIndex] : null;
		if (editingItem && !editingItem.uid) {
			editingItem.uid = genUid();
			saveCart(cart);
		}

		const effectiveName = editingItem?.name || itemName;
		const effectivePrice = editingItem && editingItem.price !== undefined ? Number(editingItem.price) : itemPrice;
		const effectiveImage = editingItem?.image || itemImage;
		const effectiveCategory = editingItem?.category || itemCategory;
		const startingNote = itemNote || editingItem?.note || "";

		let qty = editingItem?.qty || 1;
		const renderQty = () => { qtyVal.textContent = qty; };

		// Populate UI with effective data
		imgEl.src = effectiveImage;
		imgEl.alt = effectiveName;
		nameEl.textContent = effectiveName;
		priceEl.textContent = `RM ${effectivePrice.toFixed(2)}`;
		categoryEl.textContent = effectiveCategory || "";
		if (tableNumberEl) tableNumberEl.textContent = table;
		noteEl.value = startingNote;
		addBtn.textContent = editingItem ? "Update item" : "Add to cart";

		renderQty();

		decBtn.addEventListener("click", () => {
			if (qty > 1) {
				qty -= 1;
				renderQty();
			}
		});

		incBtn.addEventListener("click", () => {
			qty += 1;
			renderQty();
		});

		// Add or update cart handler
		addBtn.addEventListener("click", () => {
			const cartNow = loadCart();
			const note = noteEl.value.trim();

			if (editingIndex >= 0) {
				const target = cartNow.find((i) => i.uid === cartUid);
				if (target) {
					target.name = effectiveName;
					target.price = effectivePrice;
					target.image = effectiveImage;
					target.category = effectiveCategory;
					target.note = note;
					target.qty = qty;
					target.uid = target.uid || genUid();
					saveCart(cartNow);
					window.history.back();
					return;
				}
			}

			// Treat same item with different notes as separate rows
			const existing = cartNow.find((i) => i.id === itemId && (i.note || "") === note);
			if (existing) {
				existing.uid = existing.uid || genUid();
				existing.qty = (existing.qty || 0) + qty;
				// ensure latest display data
				existing.name = effectiveName;
				existing.price = effectivePrice;
				existing.image = effectiveImage;
				existing.category = effectiveCategory;
				existing.note = note;
			} else {
				cartNow.push({
					uid: genUid(),
					id: itemId,
					name: effectiveName,
					price: effectivePrice,
					image: effectiveImage,
					category: effectiveCategory,
					qty,
					note,
				});
			}

			saveCart(cartNow);
			window.history.back();
		});
	</script>
</body>
</html>
